<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joseph's Path to Glory</title>

    <!-- PWA & Icons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e63946">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Path to Glory">
    <meta name="description" content="Fill your plate with opportunity - College football recruiting tracker">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /**
         * Joseph's Path to Glory - v1.6 Multi-Action System
         * Date: 2025-11-22
         *
         * Features:
         * - Action item fields on school edit form
         * - Quick-add action button on Actions tab
         * - Team ID display in Settings (for onboarding new members)
         * - Overdue action highlights with visual indicators
         * - AI School Discovery (reverse lookup with filters)
         * - Firebase cloud sync (real-time multi-device)
         * - Google Sign-In authentication
         * - AI-powered school research (Claude Sonnet 4)
         * - Multi-factor scoring system (5 dimensions)
         * - Position versatility assessment (TE/FB hybrid)
         * - School database (localStorage + Firestore)
         * - Offline support with auto-sync
         * - Export/Import backup
         * - Mobile-first responsive design
         * - Dark mode theme (XOS Digital style)
         *
         * UTF-8 Encoding: Yes (emojis: üèàüìäüí∞)
         * Dependencies: Firebase SDK (CDN)
         */

        /* ===== CSS VARIABLES (XOS Digital Professional Theme) ===== */
        :root {
            --color-bg-primary: #1a1d23;
            --color-bg-secondary: #252a33;
            --color-bg-tertiary: #2f3640;
            --color-accent-primary: #e63946;
            --color-accent-secondary: #ff6b6b;
            --color-text-primary: #ffffff;
            --color-text-secondary: #a0a0a0;
            --color-text-muted: #6c7a89;
            --color-border: #3d4450;
            --color-success: #2ecc71;
            --color-warning: #f39c12;
            --color-danger: #e63946;
            --color-info: #3498db;

            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            --border-radius: 8px;
            --transition: all 0.2s ease;
        }

        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 80px; /* Space for mobile nav */
        }

        /* ===== TYPOGRAPHY ===== */
        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        /* ===== LAYOUT CONTAINERS ===== */
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 1rem;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* ===== HEADER ===== */
        .app-header {
            background: var(--color-bg-secondary);
            padding: 1rem;
            border-bottom: 2px solid var(--color-accent-primary);
            margin-bottom: 1rem;
        }

        .app-branding {
            text-align: center;
        }

        .app-title {
            font-size: 1.5rem;
            margin: 0;
            background: linear-gradient(135deg, var(--color-accent-primary), var(--color-accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-tagline {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            margin: 0.25rem 0 0 0;
            font-style: italic;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-height: 44px;
            text-align: center;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--color-accent-primary);
            color: var(--color-bg-primary);
        }

        .btn-primary:hover {
            background: #00b8e6;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-bg-secondary);
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: var(--color-success);
            color: var(--color-bg-primary);
        }

        .btn-block {
            width: 100%;
            display: block;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            color: var(--color-text-primary);
            font-size: 1rem;
            font-family: var(--font-family);
            min-height: 44px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ===== SCHOOL CARDS ===== */
        .school-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .school-card {
            background: var(--color-bg-secondary);
            border: 2px solid var(--color-border);
            border-radius: 16px;
            padding: 1rem;
            cursor: pointer;
            transition: var(--transition);
            /* Plate-rim effect */
            box-shadow: inset 0 0 0 3px var(--color-bg-tertiary);
        }

        .school-card:hover {
            border-color: var(--color-accent-primary);
            transform: translateY(-2px);
            box-shadow: inset 0 0 0 3px var(--color-bg-tertiary), 0 4px 12px rgba(57, 255, 20, 0.3);
        }

        .school-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .school-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .school-rating {
            background: var(--color-accent-secondary);
            color: var(--color-bg-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .school-meta {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .school-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .badge-juco { background: var(--color-info); color: white; }
        .badge-d1 { background: var(--color-success); color: white; }
        .badge-d2 { background: var(--color-warning); color: var(--color-bg-primary); }
        .badge-d3 { background: var(--color-accent-secondary); color: var(--color-bg-primary); }
        .badge-naia { background: var(--color-text-muted); color: white; }

        .badge-target { background: var(--color-success); color: white; }
        .badge-safety { background: var(--color-info); color: white; }
        .badge-reach { background: var(--color-warning); color: var(--color-bg-primary); }

        .school-action {
            color: var(--color-text-muted);
            font-size: 0.85rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--color-border);
        }

        /* ===== FILTERS & SEARCH ===== */
        .controls {
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: 20px;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn.active {
            background: var(--color-accent-primary);
            color: var(--color-bg-primary);
            border-color: var(--color-accent-primary);
        }

        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-box input {
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
        }

        /* ===== STATS ===== */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--color-bg-secondary);
            border: 2px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .stat-card:hover {
            border-color: var(--color-accent-primary);
            transform: translateY(-2px);
        }

        .stat-card.active {
            border-color: var(--color-accent-primary);
            background: var(--color-bg-tertiary);
            box-shadow: 0 0 10px rgba(230, 57, 70, 0.3);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-accent-primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-top: 0.25rem;
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--color-border);
            margin-bottom: 1rem;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--color-accent-primary);
            border-bottom-color: var(--color-accent-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== RATINGS ===== */
        .rating-group {
            margin-bottom: 1rem;
        }

        .rating-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .rating-label {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .stars {
            display: flex;
            gap: 0.25rem;
        }

        .star {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text-muted);
            transition: var(--transition);
        }

        .star.filled {
            color: var(--color-accent-secondary);
        }

        .overall-rating {
            background: var(--color-bg-tertiary);
            border: 2px solid var(--color-accent-primary);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .overall-rating .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-accent-secondary);
        }

        .overall-rating .label {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        /* ===== CONTACT/ACTION HISTORY ===== */
        .history-item {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-date {
            color: var(--color-text-muted);
            font-size: 0.85rem;
        }

        .history-method {
            background: var(--color-accent-primary);
            color: var(--color-bg-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .history-notes {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .history-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            min-height: auto;
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 2rem;
        }

        .modal-content {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* ===== BOTTOM NAVIGATION (Mobile) ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--color-bg-secondary);
            border-top: 2px solid var(--color-accent-primary);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem;
            z-index: 100;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-btn.active {
            color: var(--color-accent-primary);
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--color-text-muted);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-message {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }

        /* ===== UTILITY CLASSES ===== */
        .text-center { text-align: center; }
        .text-muted { color: var(--color-text-muted); }
        .text-success { color: var(--color-success); }
        .text-warning { color: var(--color-warning); }
        .text-danger { color: var(--color-danger); }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .hidden { display: none; }

        /* ===== DESKTOP NAV (Hidden on Mobile) ===== */
        .desktop-nav {
            display: none;
        }

        /* ===== RESPONSIVE (Desktop) ===== */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                padding: 2rem;
            }

            .school-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .bottom-nav {
                display: none;
            }

            body {
                padding-bottom: 0;
            }

            .app-header {
                margin-bottom: 2rem;
            }

            .desktop-nav {
                display: flex;
                justify-content: center;
                gap: 1rem;
                margin-top: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .school-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- App Header -->
    <div class="app-header">
        <div class="app-branding">
            <h1 class="app-title"><span style="-webkit-text-fill-color: initial; background: none;">üçΩÔ∏è</span> Joseph's Path to Glory</h1>
            <p class="app-tagline">Fill Your Plate with Opportunity</p>
        </div>
        <div class="desktop-nav">
            <button class="btn btn-secondary nav-btn" data-view="dashboard">Dashboard</button>
            <button class="btn btn-secondary nav-btn" data-view="discover">üîç Discover Schools</button>
            <button class="btn btn-secondary nav-btn" data-view="actions">Actions</button>
            <button class="btn btn-secondary nav-btn" data-view="settings">Settings</button>
        </div>
        <!-- Auth UI -->
        <div id="auth-ui" style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto;">
            <span id="user-email" style="font-size: 0.9rem; color: var(--color-text-secondary);"></span>
            <button id="sign-in-btn" class="btn btn-primary btn-small" onclick="App.Auth.signIn()" style="display: none;">Sign In</button>
            <button id="sign-out-btn" class="btn btn-secondary btn-small" onclick="App.Auth.signOut()" style="display: none;">Sign Out</button>
            <span id="sync-status" style="font-size: 0.85rem; color: var(--color-success); display: none;">‚òÅÔ∏è Synced</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="view active">
            <div class="btn-group">
                <button class="btn btn-primary" onclick="App.UI.showAddSchoolModal()">üçΩÔ∏è Add to Plate</button>
                <button class="btn btn-secondary" onclick="App.UI.showView('research')">üîç Scout Opportunities</button>
            </div>

            <!-- Stats (clickable filters) -->
            <div class="stats">
                <div class="stat-card active" data-stat-filter="all" onclick="App.UI.setStatFilter('all')">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">üçΩÔ∏è On Plate</div>
                </div>
                <div class="stat-card" data-stat-filter="offers" onclick="App.UI.setStatFilter('offers')">
                    <div class="stat-value" id="stat-offers">0</div>
                    <div class="stat-label">üèà Offers</div>
                </div>
                <div class="stat-card" data-stat-filter="priority" onclick="App.UI.setStatFilter('priority')">
                    <div class="stat-value" id="stat-priority">0</div>
                    <div class="stat-label">‚≠ê Priority</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <!-- Search -->
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Search schools...">
                </div>

                <!-- Filter by Level -->
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="JUCO">JUCO</button>
                    <button class="filter-btn" data-filter="D1">D1</button>
                    <button class="filter-btn" data-filter="D2">D2</button>
                    <button class="filter-btn" data-filter="D3">D3</button>
                    <button class="filter-btn" data-filter="NAIA">NAIA</button>
                </div>

                <!-- Filter by Contributor -->
                <div class="form-group">
                    <label for="contributor-filter">Filter by Contributor</label>
                    <select id="contributor-filter">
                        <option value="all">All Contributors</option>
                    </select>
                </div>

                <!-- Sort -->
                <div class="form-group">
                    <label for="sort-select">Sort by</label>
                    <select id="sort-select">
                        <option value="interest">Interest Level</option>
                        <option value="rating">Overall Rating</option>
                        <option value="overall-score">Overall Score</option>
                        <option value="playing-time">Playing Time Score</option>
                        <option value="position-dev">Position Development</option>
                        <option value="transfer">Transfer Pipeline</option>
                        <option value="coaching">Coaching Stability</option>
                        <option value="academic">Academic Fit</option>
                        <option value="date">Date Added</option>
                        <option value="name">School Name</option>
                    </select>
                </div>
            </div>

            <!-- School Grid -->
            <div id="school-grid" class="school-grid">
                <!-- School cards will be rendered here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="empty-state hidden">
                <div class="empty-icon">üçΩÔ∏è</div>
                <div class="empty-message">Your plate is empty!</div>
                <p class="text-muted" style="margin-bottom: 1rem;">Start adding schools to fill it with opportunity</p>
                <button class="btn btn-primary" onclick="App.UI.showAddSchoolModal()">üçΩÔ∏è Add First School to Plate</button>
            </div>
        </div>

        <!-- RESEARCH VIEW -->
        <div id="research-view" class="view">
            <button class="btn btn-secondary mb-2" onclick="App.UI.showView('dashboard')">‚Üê Back to Dashboard</button>

            <h2>ü§ñ Research School with AI</h2>
            <p class="text-muted mb-2">Enter a school name to get comprehensive recruiting analysis powered by Claude AI.</p>

            <!-- Search Form -->
            <div class="form-group">
                <label for="research-input">School Name</label>
                <input type="text" id="research-input" placeholder="e.g., Iowa Western Community College, Quincy University">
                <small class="text-muted">Examples: "Iowa Western CC", "Coffeyville Community College", "Hutchinson CC"</small>
            </div>

            <button class="btn btn-primary btn-block mb-2" onclick="App.API.researchSchool()">
                üîç Research School
            </button>

            <!-- Loading State -->
            <div id="research-loading" class="hidden" style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                <p>Researching school with Claude AI...</p>
                <p class="text-muted">This may take 10-30 seconds</p>
            </div>

            <!-- Error State -->
            <div id="research-error" class="hidden" style="background: var(--color-bg-secondary); border: 1px solid var(--color-danger); border-radius: var(--border-radius); padding: 1rem; margin-top: 1rem;">
                <h3 style="color: var(--color-danger);">‚ö†Ô∏è Error</h3>
                <p id="research-error-message"></p>
            </div>

            <!-- Results -->
            <div id="research-results" class="hidden">
                <div class="btn-group mb-2">
                    <button class="btn btn-success" onclick="App.API.saveResearchedSchool()">üíæ Save to Tracker</button>
                    <button class="btn btn-secondary" onclick="App.API.clearResearch()">üîÑ Research Another</button>
                </div>

                <div id="research-results-content">
                    <!-- Results will be rendered here -->
                </div>
            </div>
        </div>

        <!-- DISCOVER SCHOOLS VIEW -->
        <div id="discover-view" class="view">
            <button class="btn btn-secondary mb-2" onclick="App.UI.showView('dashboard')">‚Üê Back to Dashboard</button>

            <h2>üîç Discover Schools</h2>
            <p class="text-muted mb-2">Find schools that match Joseph's profile using AI analysis. Filter by level, location, and get top-ranked recommendations.</p>

            <!-- Filter Section -->
            <div style="background: var(--color-bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem;">
                <h3 style="margin-top: 0;">Search Filters</h3>

                <!-- Level Selection -->
                <div class="form-group">
                    <label>School Level (select one or more)</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" id="discover-level-juco" value="JUCO" checked>
                            <span>JUCO</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" id="discover-level-d1" value="D1">
                            <span>D1</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" id="discover-level-d2" value="D2">
                            <span>D2</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" id="discover-level-d3" value="D3">
                            <span>D3</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer;">
                            <input type="checkbox" id="discover-level-naia" value="NAIA">
                            <span>NAIA</span>
                        </label>
                    </div>
                </div>

                <!-- State Selection -->
                <div class="form-group">
                    <label for="discover-state">State (optional)</label>
                    <select id="discover-state">
                        <option value="">Any State</option>
                        <option value="IL">Illinois</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="NE">Nebraska</option>
                        <option value="MO">Missouri</option>
                        <option value="WI">Wisconsin</option>
                        <option value="IN">Indiana</option>
                        <option value="MN">Minnesota</option>
                        <option value="MI">Michigan</option>
                        <option value="OH">Ohio</option>
                        <option value="SD">South Dakota</option>
                        <option value="ND">North Dakota</option>
                    </select>
                </div>

                <!-- Conference -->
                <div class="form-group">
                    <label for="discover-conference">Conference (optional)</label>
                    <input type="text" id="discover-conference" placeholder="e.g., NJCAA Region 16, Big Ten">
                    <small class="text-muted">Leave blank to search all conferences</small>
                </div>

                <!-- Minimum Score -->
                <div class="form-group">
                    <label for="discover-min-score">Minimum Overall Score: <span id="discover-score-value">3.0</span>/5</label>
                    <input type="range" id="discover-min-score" min="2.0" max="4.5" step="0.5" value="3.0"
                           style="width: 100%;"
                           oninput="document.getElementById('discover-score-value').textContent = this.value">
                </div>

                <button class="btn btn-primary btn-block" onclick="App.Discover.findSchools()">
                    üéØ Find Top 10 Schools
                </button>
            </div>

            <!-- Loading State -->
            <div id="discover-loading" class="hidden" style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                <p>AI is analyzing schools across the country...</p>
                <p class="text-muted">This may take 20-40 seconds</p>
            </div>

            <!-- Error State -->
            <div id="discover-error" class="hidden" style="background: var(--color-bg-secondary); border: 1px solid var(--color-danger); border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1rem;">
                <h3 style="color: var(--color-danger);">‚ö†Ô∏è Error</h3>
                <p id="discover-error-message"></p>
            </div>

            <!-- Results -->
            <div id="discover-results" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Top Schools for Joseph</h3>
                    <button class="btn btn-secondary btn-small" onclick="App.Discover.clearResults()">üîÑ New Search</button>
                </div>

                <div id="discover-results-grid" style="display: grid; gap: 1rem;">
                    <!-- Results will be rendered here -->
                </div>
            </div>
        </div>

        <!-- DETAIL VIEW -->
        <div id="detail-view" class="view">
            <button class="btn btn-secondary mb-2" onclick="App.UI.showView('dashboard')">‚Üê Back to Dashboard</button>

            <div id="detail-content">
                <!-- Detail content will be rendered here -->
            </div>
        </div>

        <!-- ACTIONS VIEW -->
        <div id="actions-view" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0;">All Actions</h2>
                <button class="btn btn-primary" onclick="App.UI.showQuickAddAction()">+ Add Action</button>
            </div>

            <!-- Action Filters -->
            <div class="filters" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                <select id="action-filter-status" onchange="App.UI.renderActions()" style="padding: 0.5rem; border-radius: 8px; background: var(--color-bg-secondary); color: var(--color-text-primary); border: 1px solid var(--color-border);">
                    <option value="all">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Complete">Complete</option>
                    <option value="overdue">Overdue</option>
                </select>
                <select id="action-filter-owner" onchange="App.UI.renderActions()" style="padding: 0.5rem; border-radius: 8px; background: var(--color-bg-secondary); color: var(--color-text-primary); border: 1px solid var(--color-border);">
                    <option value="all">All Owners</option>
                    <option value="John">John</option>
                    <option value="Joseph">Joseph</option>
                    <option value="Mom">Mom</option>
                    <option value="Coach">Coach</option>
                </select>
                <select id="action-filter-school" onchange="App.UI.renderActions()" style="padding: 0.5rem; border-radius: 8px; background: var(--color-bg-secondary); color: var(--color-text-primary); border: 1px solid var(--color-border); max-width: 150px;">
                    <option value="all">All Schools</option>
                    <!-- Populated dynamically -->
                </select>
            </div>

            <div id="actions-content">
                <!-- Actions will be rendered here -->
            </div>
        </div>

        <!-- QUICK ADD ACTION MODAL -->
        <div id="quick-action-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Add Action</h2>
                    <button class="modal-close" onclick="App.UI.closeModal('quick-action-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Single school select (for editing) -->
                    <div class="form-group" id="quick-action-school-single-group">
                        <label for="quick-action-school">School *</label>
                        <select id="quick-action-school" required onchange="App.UI.onSchoolSelectChange()">
                            <option value="">Select school...</option>
                        </select>
                    </div>
                    <!-- Multi school select (for adding) -->
                    <div class="form-group" id="quick-action-school-multi-group" style="display: none;">
                        <label>Schools * <span class="text-muted" style="font-size: 0.8rem;">(select multiple)</span></label>
                        <div id="quick-action-schools-checkboxes" style="max-height: 200px; overflow-y: auto; background: var(--color-bg-tertiary); border-radius: 8px; padding: 0.5rem;">
                            <!-- Checkboxes populated dynamically -->
                        </div>
                    </div>
                    <!-- Action Mode (Add new vs Replace) - shown when school has existing actions -->
                    <div class="form-group" id="quick-action-mode-group" style="display: none;">
                        <label>Action Mode</label>
                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="quick-action-mode" value="add" checked onchange="App.UI.onActionModeChange()">
                                <span>Add new action</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="quick-action-mode" value="replace" onchange="App.UI.onActionModeChange()">
                                <span>Replace existing</span>
                            </label>
                        </div>
                    </div>
                    <!-- Select action to replace -->
                    <div class="form-group" id="quick-action-replace-group" style="display: none;">
                        <label>Select action to replace *</label>
                        <div id="quick-action-replace-list" style="max-height: 150px; overflow-y: auto; background: var(--color-bg-tertiary); border-radius: 8px; padding: 0.5rem;">
                            <!-- Radio buttons populated dynamically -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="quick-action-task">Action Item *</label>
                        <input type="text" id="quick-action-task" placeholder="e.g., Send film, Schedule visit" required>
                    </div>
                    <div class="form-group">
                        <label for="quick-action-owner">Owner</label>
                        <select id="quick-action-owner">
                            <option value="">Not assigned</option>
                            <option value="John">John</option>
                            <option value="Joseph">Joseph</option>
                            <option value="Mom">Mom</option>
                            <option value="Coach">Coach</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quick-action-due">Due Date</label>
                        <input type="date" id="quick-action-due">
                    </div>
                    <div class="form-group" id="quick-action-status-group">
                        <label for="quick-action-status">Status</label>
                        <select id="quick-action-status">
                            <option value="Pending">Pending</option>
                            <option value="Complete">Complete</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="App.UI.closeModal('quick-action-modal')">Cancel</button>
                    <button class="btn btn-danger" id="quick-action-delete-btn" onclick="App.UI.deleteQuickAction()" style="margin-right: auto; display: none;">Delete</button>
                    <button class="btn btn-primary" onclick="App.UI.saveQuickAction()">Save Action</button>
                </div>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="settings-view" class="view">
            <h2>Settings</h2>

            <!-- Team Info Section -->
            <div id="team-info-section" class="info-box" style="background: var(--color-bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: none;">
                <h3 style="margin-top: 0;">üë• Team Info</h3>
                <div style="margin-bottom: 0.75rem;">
                    <strong>Team Name:</strong> <span id="team-name-display">‚Äî</span>
                </div>
                <div style="margin-bottom: 0.75rem;">
                    <strong>Team ID:</strong>
                    <code id="team-id-display" style="background: var(--color-bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; margin-left: 0.5rem;">‚Äî</code>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-left: 0.5rem;" onclick="App.UI.copyTeamId()">üìã Copy</button>
                </div>
                <p style="margin-bottom: 0; font-size: 0.85rem; color: var(--color-text-muted);">Share this Team ID with family members so they can join your team.</p>
            </div>

            <div class="info-box" style="background: var(--color-bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h3 style="margin-top: 0;">‚úÖ AI Research Ready</h3>
                <p style="margin-bottom: 0;">Claude API is configured and ready to use. No setup required - just click "Research with AI" to analyze any school!</p>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="App.Storage.exportData()">üì• Export Data</button>
                <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">üì§ Import Data</button>
            </div>
            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="App.Storage.importData(event)">

            <div class="form-group mt-2">
                <button class="btn btn-danger btn-block" onclick="App.Storage.clearAllData()">üóëÔ∏è Clear All Data</button>
                <small class="text-muted">Warning: This will delete all schools. Export first!</small>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav">
        <button class="nav-btn active" data-view="dashboard">
            <span class="nav-icon">üìä</span>
            <span>Dashboard</span>
        </button>
        <button class="nav-btn" data-view="discover">
            <span class="nav-icon">üîç</span>
            <span>Discover</span>
        </button>
        <button class="nav-btn" data-view="actions">
            <span class="nav-icon">‚úì</span>
            <span>Actions</span>
        </button>
        <button class="nav-btn" data-view="settings">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Settings</span>
        </button>
    </nav>

    <!-- ADD/EDIT SCHOOL MODAL -->
    <div id="school-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Add School</h2>
                <button class="modal-close" onclick="App.UI.closeModal('school-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="school-form">
                    <input type="hidden" id="form-school-id">

                    <div class="form-group">
                        <label for="form-school-name">School Name *</label>
                        <input type="text" id="form-school-name" required>
                    </div>

                    <div class="form-group">
                        <label for="form-level">Level *</label>
                        <select id="form-level" required>
                            <option value="">Select level...</option>
                            <option value="JUCO">JUCO</option>
                            <option value="D1">D1</option>
                            <option value="D2">D2</option>
                            <option value="D3">D3</option>
                            <option value="NAIA">NAIA</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="form-location">Location *</label>
                        <input type="text" id="form-location" placeholder="City, State" required>
                    </div>

                    <div class="form-group">
                        <label for="form-conference">Conference</label>
                        <input type="text" id="form-conference" placeholder="e.g., KJCCC, ICCAC">
                    </div>

                    <h3 class="mt-2 mb-1">Coaching Staff</h3>

                    <div class="form-group">
                        <label for="form-head-coach">Head Coach</label>
                        <input type="text" id="form-head-coach">
                    </div>

                    <div class="form-group">
                        <label for="form-te-coach">TE/Position Coach</label>
                        <input type="text" id="form-te-coach">
                    </div>

                    <div class="form-group">
                        <label for="form-recruiting-contact">Recruiting Contact</label>
                        <input type="text" id="form-recruiting-contact">
                    </div>

                    <div class="form-group">
                        <label for="form-phone">Phone</label>
                        <input type="tel" id="form-phone">
                    </div>

                    <div class="form-group">
                        <label for="form-email">Email</label>
                        <input type="email" id="form-email">
                    </div>

                    <div class="form-group">
                        <label for="form-twitter">Twitter Handle(s)</label>
                        <input type="text" id="form-twitter" placeholder="@handle1, @handle2">
                    </div>

                    <h3 class="mt-2 mb-1">Status</h3>

                    <div class="form-group">
                        <label for="form-interest-our">Our Interest Level</label>
                        <select id="form-interest-our">
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="form-interest-their">Their Interest Level</label>
                        <select id="form-interest-their">
                            <option value="Unknown">Unknown</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="form-likelihood">Likelihood</label>
                        <select id="form-likelihood">
                            <option value="Target">Target</option>
                            <option value="Safety">Safety</option>
                            <option value="Reach">Reach</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="form-offer-status">Offer Status</label>
                        <select id="form-offer-status">
                            <option value="None">None</option>
                            <option value="Interested">Interested</option>
                            <option value="Verbal Offer">Verbal Offer</option>
                            <option value="Official Offer">Official Offer</option>
                        </select>
                    </div>

                    <h3 class="mt-2 mb-1">Next Action</h3>

                    <div class="form-group">
                        <label for="form-next-action">Action Item</label>
                        <input type="text" id="form-next-action" placeholder="e.g., Schedule campus visit, Send film">
                    </div>

                    <div class="form-group">
                        <label for="form-action-owner">Owner</label>
                        <select id="form-action-owner">
                            <option value="">Not assigned</option>
                            <option value="John">John</option>
                            <option value="Joseph">Joseph</option>
                            <option value="Mom">Mom</option>
                            <option value="Coach">Coach</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="form-action-due">Due Date</label>
                        <input type="date" id="form-action-due">
                    </div>

                    <div class="form-group">
                        <label for="form-action-status">Status</label>
                        <select id="form-action-status">
                            <option value="Pending">Pending</option>
                            <option value="Complete">Complete</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="form-notes">Notes</label>
                        <textarea id="form-notes" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.UI.closeModal('school-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.UI.saveSchool()">Save School</button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Confirm Delete</h2>
                <button class="modal-close" onclick="App.UI.closeModal('delete-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="delete-school-name"></strong>?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.UI.closeModal('delete-modal')">Cancel</button>
                <button class="btn btn-danger" onclick="App.UI.confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- VERIFY & UPDATE MODAL -->
    <div id="verify-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîç Verify & Update School Data</h2>
                <button class="modal-close" onclick="App.UI.closeModal('verify-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="verify-school-id">

                <p class="text-muted mb-2">Update outdated AI data with current information. Check the school's official athletics website or 247Sports for the latest details.</p>

                <h3>Coaching Staff</h3>
                <div class="form-group">
                    <label for="verify-head-coach">Head Coach</label>
                    <input type="text" id="verify-head-coach" placeholder="e.g., Ryan Walters (2023-present)">
                </div>

                <div class="form-group">
                    <label for="verify-te-coach">TE/Position Coach</label>
                    <input type="text" id="verify-te-coach" placeholder="e.g., Drew Mehringer">
                </div>

                <div class="form-group">
                    <label for="verify-recruiting-contact">Recruiting Contact</label>
                    <input type="text" id="verify-recruiting-contact">
                </div>

                <div class="form-group">
                    <label for="verify-phone">Phone</label>
                    <input type="tel" id="verify-phone">
                </div>

                <div class="form-group">
                    <label for="verify-email">Email</label>
                    <input type="email" id="verify-email">
                </div>

                <div class="form-group">
                    <label for="verify-twitter">Twitter Handle(s)</label>
                    <input type="text" id="verify-twitter" placeholder="@CoachName, @TeamRecruiting">
                </div>

                <h3 class="mt-2">Current Season Info</h3>
                <div class="form-group">
                    <label for="verify-recent-record">Recent Record</label>
                    <input type="text" id="verify-recent-record" placeholder="e.g., 4-8 in 2024, 1-2 in 2025">
                    <small class="text-muted">Include current season and 1-2 previous seasons</small>
                </div>

                <div class="form-group">
                    <label for="verify-program-momentum">Program Momentum</label>
                    <select id="verify-program-momentum">
                        <option value="">Select...</option>
                        <option value="Up">Up - Improving record/recruiting</option>
                        <option value="Down">Down - Declining performance</option>
                        <option value="Stable">Stable - Consistent performance</option>
                        <option value="Rebuilding">Rebuilding - New coach/system</option>
                    </select>
                </div>

                <p class="text-muted mt-2"><strong>Tip:</strong> Check official athletics sites, 247Sports, or On3 for current info.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.UI.closeModal('verify-modal')">Cancel</button>
                <button class="btn btn-success" onclick="App.UI.saveVerification()">‚úÖ Save Verified Data</button>
            </div>
        </div>
    </div>

    <!-- Team Setup Modal -->
    <div id="team-setup-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ü§ù Team Setup</h2>
            </div>
            <div class="modal-body">
                <p>To collaborate with family and coaches, you need to create or join a team.</p>

                <div style="display: grid; gap: 1rem; margin-top: 1.5rem;">
                    <div style="background: var(--color-bg-secondary); border: 2px solid var(--color-accent-primary); border-radius: var(--border-radius); padding: 1rem;">
                        <h3>Create New Team</h3>
                        <p class="text-muted">Start a new recruiting team and invite others to join.</p>
                        <div class="form-group">
                            <label for="new-team-name">Team Name</label>
                            <input type="text" id="new-team-name" placeholder="e.g., Joseph's Recruiting Team">
                        </div>
                        <button class="btn btn-primary btn-block" onclick="App.UI.createTeamFromModal()">Create Team</button>
                    </div>

                    <div style="background: var(--color-bg-secondary); border: 2px solid var(--color-info); border-radius: var(--border-radius); padding: 1rem;">
                        <h3>Join Existing Team</h3>
                        <p class="text-muted">Enter the Team ID shared by your family member or coach.</p>
                        <div class="form-group">
                            <label for="join-team-id">Team ID</label>
                            <input type="text" id="join-team-id" placeholder="Paste team ID here">
                        </div>
                        <button class="btn btn-secondary btn-block" onclick="App.UI.joinTeamFromModal()">Join Team</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        /**
         * Joseph's Path to Glory - Application Logic
         * Version: 1.1 Team Collaboration
         */

        // ===== FIREBASE INITIALIZATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyAHAFSwcBkFn9uy8T-Mqer927_c-BzfBRI",
            authDomain: "joseph-path-glory.firebaseapp.com",
            projectId: "joseph-path-glory",
            storageBucket: "joseph-path-glory.firebasestorage.app",
            messagingSenderId: "624170158090",
            appId: "1:624170158090:web:a77969957a9554179ef7f3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Enable offline persistence
        db.enablePersistence()
            .catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.warn('Offline persistence failed: Multiple tabs open');
                } else if (err.code === 'unimplemented') {
                    console.warn('Offline persistence not available in this browser');
                }
            });

        const App = {
            // ===== AUTH MODULE =====
            Auth: {
                currentUser: null,

                // Initialize authentication
                init() {
                    // Listen for auth state changes
                    auth.onAuthStateChanged(async (user) => {
                        this.currentUser = user;
                        this.updateUI();

                        if (user) {
                            console.log('User signed in:', user.email);

                            // Check if user has a team
                            const team = await App.Team.getCurrentTeam();

                            if (!team) {
                                // No team - show setup modal
                                console.log('No team found, showing setup modal');
                                App.UI.showTeamSetupModal();
                            } else {
                                // Has team - proceed with migration and sync
                                console.log('Team found:', team.name);
                                // Migrate local data to cloud on first sign-in
                                App.CloudSync.migrateLocalToCloud();
                                // Start real-time sync
                                App.CloudSync.startRealtimeSync();
                            }
                        } else {
                            console.log('User signed out');
                            // Stop real-time sync
                            App.CloudSync.stopRealtimeSync();
                            App.Team.currentTeam = null;
                        }
                    });
                },

                // Update auth UI
                updateUI() {
                    const signInBtn = document.getElementById('sign-in-btn');
                    const signOutBtn = document.getElementById('sign-out-btn');
                    const userEmail = document.getElementById('user-email');

                    if (this.currentUser) {
                        signInBtn.style.display = 'none';
                        signOutBtn.style.display = 'inline-block';
                        userEmail.textContent = this.currentUser.email;
                        userEmail.style.display = 'inline';
                    } else {
                        signInBtn.style.display = 'inline-block';
                        signOutBtn.style.display = 'none';
                        userEmail.textContent = '';
                        userEmail.style.display = 'none';
                    }
                },

                // Sign in with Google
                async signIn() {
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        await auth.signInWithPopup(provider);
                    } catch (error) {
                        console.error('Sign-in error:', error);
                        alert('Sign-in failed: ' + error.message);
                    }
                },

                // Sign out
                async signOut() {
                    try {
                        await auth.signOut();
                    } catch (error) {
                        console.error('Sign-out error:', error);
                        alert('Sign-out failed: ' + error.message);
                    }
                }
            },

            // ===== TEAM MODULE =====
            Team: {
                currentTeam: null,

                // Get current user's team
                async getCurrentTeam() {
                    if (!auth.currentUser) return null;

                    try {
                        // Check if user is member of any team
                        const snapshot = await db.collection('teams')
                            .where('members', 'array-contains', auth.currentUser.email)
                            .limit(1)
                            .get();

                        if (!snapshot.empty) {
                            const teamDoc = snapshot.docs[0];
                            this.currentTeam = {
                                id: teamDoc.id,
                                ...teamDoc.data()
                            };
                            return this.currentTeam;
                        }

                        return null;
                    } catch (error) {
                        console.error('Error getting team:', error);
                        return null;
                    }
                },

                // Create a new team
                async createTeam(teamName) {
                    if (!auth.currentUser) {
                        throw new Error('Must be signed in to create a team');
                    }

                    try {
                        const teamData = {
                            name: teamName || 'Recruiting Team',
                            owner: auth.currentUser.email,
                            ownerName: auth.currentUser.displayName || auth.currentUser.email,
                            members: [auth.currentUser.email],
                            memberNames: {
                                [auth.currentUser.email]: auth.currentUser.displayName || auth.currentUser.email.split('@')[0]
                            },
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        const docRef = await db.collection('teams').add(teamData);

                        this.currentTeam = {
                            id: docRef.id,
                            ...teamData
                        };

                        console.log('Team created:', docRef.id);
                        return this.currentTeam;
                    } catch (error) {
                        console.error('Error creating team:', error);
                        throw error;
                    }
                },

                // Join existing team
                async joinTeam(teamId) {
                    if (!auth.currentUser) {
                        throw new Error('Must be signed in to join a team');
                    }

                    try {
                        const teamDoc = await db.collection('teams').doc(teamId).get();

                        if (!teamDoc.exists) {
                            throw new Error('Team not found');
                        }

                        // Add user to team members
                        await db.collection('teams').doc(teamId).update({
                            members: firebase.firestore.FieldValue.arrayUnion(auth.currentUser.email),
                            [`memberNames.${auth.currentUser.email}`]: auth.currentUser.displayName || auth.currentUser.email.split('@')[0]
                        });

                        this.currentTeam = {
                            id: teamDoc.id,
                            ...teamDoc.data()
                        };

                        console.log('Joined team:', teamId);
                        return this.currentTeam;
                    } catch (error) {
                        console.error('Error joining team:', error);
                        throw error;
                    }
                },

                // Add member to team (owner only)
                async addMember(email) {
                    if (!auth.currentUser || !this.currentTeam) {
                        throw new Error('Must be signed in and have a team');
                    }

                    if (this.currentTeam.owner !== auth.currentUser.email) {
                        throw new Error('Only team owner can add members');
                    }

                    try {
                        await db.collection('teams').doc(this.currentTeam.id).update({
                            members: firebase.firestore.FieldValue.arrayUnion(email)
                        });

                        console.log('Added member:', email);
                    } catch (error) {
                        console.error('Error adding member:', error);
                        throw error;
                    }
                },

                // Get team member names
                getMemberName(email) {
                    if (!this.currentTeam) return email;
                    return this.currentTeam.memberNames?.[email] || email.split('@')[0];
                }
            },

            // ===== STORAGE MODULE =====
            Storage: {
                STORAGE_KEY: 'josephs-path-glory-data',
                VERSION: '1.1',

                // Initialize storage
                init() {
                    const data = this.getData();
                    if (!data) {
                        this.setData({
                            version: this.VERSION,
                            schools: [],
                            settings: {
                                apiKey: '',
                                theme: 'dark'
                            }
                        });
                    }
                },

                // Get all data
                getData() {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    return data ? JSON.parse(data) : null;
                },

                // Set all data
                setData(data) {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                },

                // Get all schools
                getSchools() {
                    const data = this.getData();
                    return data ? data.schools : [];
                },

                // Get single school by ID
                getSchool(id) {
                    const schools = this.getSchools();
                    return schools.find(s => s.id === id);
                },

                // Add or update school
                saveSchool(school) {
                    const data = this.getData();
                    const index = data.schools.findIndex(s => s.id === school.id);

                    if (index >= 0) {
                        // Update existing
                        school.lastUpdated = new Date().toISOString();
                        data.schools[index] = school;
                    } else {
                        // Add new
                        school.id = App.Utils.generateUUID();
                        school.dateAdded = new Date().toISOString();
                        school.lastUpdated = new Date().toISOString();
                        data.schools.push(school);
                    }

                    this.setData(data);

                    // Sync to cloud (async, non-blocking)
                    App.CloudSync.saveSchoolToCloud(school);

                    return school;
                },

                // Delete school
                deleteSchool(id) {
                    const data = this.getData();
                    data.schools = data.schools.filter(s => s.id !== id);
                    this.setData(data);

                    // Delete from cloud (async, non-blocking)
                    App.CloudSync.deleteSchoolFromCloud(id);
                },

                // Get/Set API Key
                getApiKey() {
                    const data = this.getData();
                    return data.settings.apiKey || '';
                },

                setApiKey(key) {
                    const data = this.getData();
                    data.settings.apiKey = key;
                    this.setData(data);
                },

                // Export data
                exportData() {
                    const data = this.getData();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `josephs-path-glory-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    alert('Data exported successfully!');
                },

                // Import data
                importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.version && data.schools) {
                                if (confirm(`Import ${data.schools.length} schools? This will overwrite existing data.`)) {
                                    this.setData(data);
                                    App.UI.renderDashboard();
                                    alert('Data imported successfully!');
                                }
                            } else {
                                alert('Invalid backup file format.');
                            }
                        } catch (err) {
                            alert('Error reading backup file: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                },

                // Clear all data
                clearAllData() {
                    if (confirm('‚ö†Ô∏è Delete ALL schools? This cannot be undone. Export first!')) {
                        if (confirm('Are you ABSOLUTELY sure? All data will be lost.')) {
                            localStorage.removeItem(this.STORAGE_KEY);
                            this.init();
                            App.UI.renderDashboard();
                            alert('All data cleared.');
                        }
                    }
                }
            },

            // ===== CLOUD SYNC MODULE =====
            CloudSync: {
                unsubscribe: null,
                isSyncing: false,

                // Migrate local schools to Firestore
                async migrateLocalToCloud() {
                    if (!auth.currentUser || !App.Team.currentTeam) return;

                    try {
                        // Check if team already has cloud data
                        const snapshot = await db.collection('schools')
                            .where('teamId', '==', App.Team.currentTeam.id)
                            .limit(1)
                            .get();

                        // If cloud data exists, don't migrate (avoid duplicates)
                        if (!snapshot.empty) {
                            console.log('Cloud data already exists, skipping migration');
                            return;
                        }

                        // Get local schools
                        const localSchools = App.Storage.getSchools();

                        if (localSchools.length === 0) {
                            console.log('No local schools to migrate');
                            return;
                        }

                        console.log(`Migrating ${localSchools.length} schools to cloud...`);

                        // Upload each school to Firestore
                        const batch = db.batch();
                        const currentUserName = auth.currentUser.displayName || auth.currentUser.email.split('@')[0];

                        localSchools.forEach(school => {
                            const docRef = db.collection('schools').doc(school.id);
                            batch.set(docRef, {
                                ...school,
                                teamId: App.Team.currentTeam.id,
                                createdBy: auth.currentUser.email,
                                createdByName: currentUserName,
                                lastEditedBy: auth.currentUser.email,
                                lastEditedByName: currentUserName,
                                syncedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        });

                        await batch.commit();
                        console.log('Migration complete!');
                        this.showSyncStatus('Migrated to cloud ‚úì');

                    } catch (error) {
                        console.error('Migration error:', error);
                    }
                },

                // Start real-time sync listener
                startRealtimeSync() {
                    if (!auth.currentUser || !App.Team.currentTeam) return;

                    // Stop any existing listener
                    this.stopRealtimeSync();

                    console.log('Starting real-time sync...');

                    // Listen to schools collection for this team
                    this.unsubscribe = db.collection('schools')
                        .where('teamId', '==', App.Team.currentTeam.id)
                        .onSnapshot((snapshot) => {
                            console.log('Received cloud update');

                            // Get current local data
                            const data = App.Storage.getData();
                            const cloudSchools = [];

                            snapshot.forEach((doc) => {
                                cloudSchools.push({
                                    id: doc.id,
                                    ...doc.data()
                                });
                            });

                            // Update localStorage with cloud data
                            data.schools = cloudSchools;
                            App.Storage.setData(data);

                            // Refresh UI if on dashboard
                            if (App.UI.currentView === 'dashboard') {
                                App.UI.renderSchools();
                            }

                            this.showSyncStatus('Synced ‚úì');
                        }, (error) => {
                            console.error('Sync error:', error);
                        });
                },

                // Stop real-time sync listener
                stopRealtimeSync() {
                    if (this.unsubscribe) {
                        this.unsubscribe();
                        this.unsubscribe = null;
                        console.log('Stopped real-time sync');
                    }
                },

                // Save school to cloud
                async saveSchoolToCloud(school) {
                    if (!auth.currentUser || !App.Team.currentTeam) {
                        console.warn('Not signed in or no team, saving locally only');
                        return;
                    }

                    try {
                        this.showSyncStatus('Syncing...');

                        const currentUserName = auth.currentUser.displayName || auth.currentUser.email.split('@')[0];
                        const docRef = db.collection('schools').doc(school.id);
                        const docSnapshot = await docRef.get();

                        // Prepare school data with team and contributor info
                        const schoolData = {
                            ...school,
                            teamId: App.Team.currentTeam.id,
                            lastEditedBy: auth.currentUser.email,
                            lastEditedByName: currentUserName,
                            syncedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        // If school doesn't exist yet, add createdBy fields
                        if (!docSnapshot.exists) {
                            schoolData.createdBy = auth.currentUser.email;
                            schoolData.createdByName = currentUserName;
                        }

                        await docRef.set(schoolData);

                        this.showSyncStatus('Synced ‚úì');
                    } catch (error) {
                        console.error('Cloud save error:', error);
                        this.showSyncStatus('Sync failed ‚úó');
                    }
                },

                // Delete school from cloud
                async deleteSchoolFromCloud(schoolId) {
                    if (!auth.currentUser) return;

                    try {
                        await db.collection('schools').doc(schoolId).delete();
                    } catch (error) {
                        console.error('Cloud delete error:', error);
                    }
                },

                // Show sync status
                showSyncStatus(message) {
                    const statusEl = document.getElementById('sync-status');
                    if (statusEl) {
                        statusEl.textContent = message;
                        statusEl.style.display = 'inline';

                        // Hide after 3 seconds
                        setTimeout(() => {
                            statusEl.style.display = 'none';
                        }, 3000);
                    }
                }
            },

            // ===== API MODULE =====
            API: {
                currentResearchData: null,

                // Research school with Claude API
                async researchSchool() {
                    const schoolName = document.getElementById('research-input').value.trim();

                    if (!schoolName) {
                        alert('Please enter a school name');
                        return;
                    }

                    // Show loading state
                    document.getElementById('research-loading').classList.remove('hidden');
                    document.getElementById('research-error').classList.add('hidden');
                    document.getElementById('research-results').classList.add('hidden');

                    try {
                        // Build prompt from JOSEPH_CONTEXT.md
                        const prompt = this.buildResearchPrompt(schoolName);

                        // Call Claude API via Cloudflare Worker proxy
                        // API key stored securely in Worker secrets - no need to send from client
                        const response = await fetch('https://josephs-path-glory-proxy.dronescout-api.workers.dev', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'anthropic-version': '2023-06-01'
                            },
                            body: JSON.stringify({
                                model: 'claude-sonnet-4-20250514',
                                max_tokens: 4000,
                                messages: [{
                                    role: 'user',
                                    content: prompt
                                }]
                            })
                        });

                        if (!response.ok) {
                            const errorBody = await response.text();
                            console.error('API Error Response:', errorBody);
                            throw new Error(`API Error: ${response.status} - ${errorBody.substring(0, 200)}`);
                        }

                        const data = await response.json();
                        const aiResponse = data.content[0].text;

                        // Parse JSON response
                        let schoolData;
                        try {
                            schoolData = JSON.parse(aiResponse);
                        } catch (e) {
                            // Try to extract JSON if wrapped in markdown
                            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                schoolData = JSON.parse(jsonMatch[0]);
                            } else {
                                throw new Error('Could not parse AI response as JSON');
                            }
                        }

                        // Store research data
                        this.currentResearchData = schoolData;

                        // Hide loading, show results
                        document.getElementById('research-loading').classList.add('hidden');
                        this.displayResults(schoolData);

                    } catch (error) {
                        console.error('Research error:', error);
                        document.getElementById('research-loading').classList.add('hidden');
                        document.getElementById('research-error').classList.remove('hidden');
                        document.getElementById('research-error-message').textContent =
                            error.message || 'An error occurred while researching. Please try again.';
                    }
                },

                // Build research prompt
                buildResearchPrompt(schoolName) {
                    return `You are a college football recruiting analyst with a Chief of Staff mindset. Research and provide a comprehensive assessment of ${schoolName} for a high school senior tight end recruit (Joseph).

YOUR APPROACH:
- High-impact brevity - Cut through recruiting hype, focus on facts
- Skeptical lens - Challenge assumptions, identify red flags early
- Forward-thinking - Consider Joseph's path 2-4 years out (transfer pipeline, eligibility)
- Reality-based - No aspirational thinking, only what's likely given his profile

CRITICAL CONTEXT - JOSEPH'S SITUATION:
- HS senior TE who missed junior season (injury) - LIMITED FILM
- Mid-to-low 2.X GPA, no standardized test scores - ACADEMIC RISK
- Position versatility: PRIMARY = Blocking TE/Fullback hybrid, SECONDARY = Pass catching
- Strengths: In-line blocking, lead blocking, pass protection, physicality
- Can play: In-line TE, H-back, Fullback, move TE, Y-TE (blocking emphasis)
- Needs to build more game film for transfer opportunities
- Two years of eligibility remaining (critical for 4-year vs JUCO decision)
- Looking at JUCO, D2, D3, NAIA, or D1 options
- Current situation: 1 actual offer (Elmhurst D3), active recruiting interest from Beloit (D3) and Quincy (D2)
- Top JUCO targets: Coffeyville CC (2024 All-American TE), Iowa Western CC (Hall of Fame coach, 150+ D1 transfers), Hutchinson CC (2024 National Champions)

POSITION ASSESSMENT REQUIREMENT:
Analyze fit for BOTH positions:
1. Tight End role (blocking TE, Y-TE, in-line TE, hybrid TE)
2. Fullback/H-back role (lead blocker, I-formation FB, offset H-back)

Don't disqualify schools that don't use TEs much if they use FBs heavily. Provide separate usage/fit scores for each position.

ASSESSMENT PRIORITIES (DO NOT base recommendations on cost - cost is informational only):
1. Playing time likelihood - Can Joseph realistically compete for snaps at this position?
2. Position development - Track record developing TEs or FBs (specific examples with names/years)
3. Transfer/advancement pipeline - Where do players go next? (D1 transfers for JUCO, NFL for D1, etc.)
4. Coaching stability - Turnover, tenure, program momentum
5. Academic fit - GPA requirements, academic support for 2.X GPA student

SCORING REQUIREMENT:
Provide 1-5 scores (decimals allowed) for each assessment priority. Explain reasoning for each score.

BE FACTUAL AND ANALYTICAL:
- If program is in chaos, say so explicitly
- Provide cost data WITHOUT affordability judgments (NO "financially prohibitive", NO "unrealistic", NO "can't afford")
- If position development is weak/nonexistent, flag it prominently
- For 4-year schools, provide objective JUCO comparison showing TRADEOFFS (not declaring one "clearly better")
- Recommendations based ONLY on playing time, development, pipeline, coaching, academics - NEVER on cost
- Challenge recruiting narratives with evidence

Provide your response in this EXACT JSON format (DO NOT include markdown code blocks, ONLY the raw JSON):

{
  "school_name": "Full official name",
  "level": "JUCO/D1/D2/D3/NAIA",
  "location": "City, State",
  "conference": "Conference name",
  "tuition_cost": "Annual cost estimate",
  "four_year_cost": "Total 4-year estimate (or 2-year for JUCO)",
  "head_coach": "Name and tenure",
  "te_coach": "TE coach name or position (be specific if it's a GA or not full-time)",
  "recruiting_contact": "Key recruiting contact",
  "phone": "Main athletics phone",
  "email": "Contact email if available",
  "twitter": "Twitter handle(s)",
  "recent_record": "Last 2-3 seasons record",
  "program_momentum": "Up/Down/Rebuilding/Stable - with brief explanation",
  "te_development": "Track record developing TEs - specific examples with names/years",
  "transfer_pipeline": "Where players transfer to (for JUCO) or quality of incoming transfers (for 4-year)",
  "scholarship_potential": "None (D3)/Limited/Moderate/Strong - with explanation specific to Joseph's profile",
  "red_flags": ["List of specific concerns for Joseph's situation"],
  "opportunities": ["List of specific positive factors for Joseph"],
  "financial_comparison": "Objective cost analysis with ROI: total cost vs scholarship potential vs transfer pipeline vs playing time opportunities. Compare to other levels (e.g., JUCO $16k, D2 $64k with scholarship, D3 $168k). Neutral tone - NO affordability judgments, NO 'financially prohibitive' language.",
  "position_fit": {
    "tight_end": {
      "usage_frequency": "High/Moderate/Low/None",
      "role_type": "Blocking TE/Receiving TE/Hybrid/Y-TE/Move TE",
      "usage_score": 3.5,
      "fit_score": 4.0,
      "notes": "Explanation of TE usage and fit for Joseph's blocking-first skill set"
    },
    "fullback_hback": {
      "usage_frequency": "High/Moderate/Low/None",
      "role_type": "Lead blocker/I-formation FB/H-back/Offset/None",
      "usage_score": 5.0,
      "fit_score": 5.0,
      "notes": "Explanation of FB/H-back usage and fit for Joseph's blocking strengths"
    },
    "best_fit_position": "Fullback/H-back or Tight End",
    "best_fit_reasoning": "Why this position is the best fit based on scheme and Joseph's strengths"
  },
  "scores": {
    "playing_time": {
      "value": 4.5,
      "reasoning": "Specific factors: roster depth, returning players, offensive system, win/loss record affecting playing time"
    },
    "position_development": {
      "value": 5.0,
      "reasoning": "Track record with specific examples: player names, years, achievements (All-American, NFL, D1 transfers)"
    },
    "transfer_pipeline": {
      "value": 4.0,
      "reasoning": "For JUCO: D1 transfer destinations and success rate. For D1: NFL draft picks. For D2/D3: grad transfers or pro opportunities"
    },
    "coaching_stability": {
      "value": 4.5,
      "reasoning": "Head coach tenure, position coach stability, recent turnover, program momentum"
    },
    "academic_fit": {
      "value": 3.0,
      "reasoning": "GPA requirements, academic support services, retention rate for student-athletes"
    }
  },
  "overall_ranking": "Reach/Target/Safety",
  "recommendation": "High Priority/Medium Priority/Low Priority/Skip - Based ONLY on playing time, development, pipeline, coaching, academics. NOT on cost.",
  "contact_strategy": "Recommended approach (Twitter DM first/Email/Phone/In-person) with timing. Mention best fit position in outreach.",
  "contact_script_twitter": "Sample 280-character Twitter DM mentioning best fit position, ready to copy/paste",
  "contact_script_email": "Sample email with subject line and 2-3 paragraph body mentioning best fit position, ready to copy/paste",
  "comparison_to_juco": "If this is a 4-year school: Objective comparison to JUCO showing TRADEOFFS of both paths. Neutral tone - present both options fairly, don't declare one 'clearly better'. If JUCO school: null"
}`;
                },

                // Display results
                displayResults(data) {
                    const html = `
                        <div style="background: var(--color-bg-secondary); border: 2px solid var(--color-accent-primary); border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1.5rem;">
                            <h2>${data.school_name}</h2>
                            <p><span class="school-badge badge-${data.level?.toLowerCase() || 'juco'}">${data.level}</span> ${data.location}</p>
                            <p><strong>Conference:</strong> ${data.conference || 'N/A'}</p>
                            ${data.recommendation ? `<p style="color: var(--color-success); font-weight: 700; font-size: 1.1rem;">üìã Recommendation: ${data.recommendation}</p>` : ''}
                        </div>

                        <div style="display: grid; gap: 1.5rem;">
                            ${data.position_fit ? `
                                <!-- Position Fit Assessment -->
                                <div style="background: var(--color-bg-secondary); border: 2px solid var(--color-accent-primary); border-radius: var(--border-radius); padding: 1rem;">
                                    <h3>üìç Position Fit Assessment</h3>
                                    <div style="background: var(--color-bg-tertiary); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                        <p style="margin: 0 0 0.5rem 0; font-weight: 700; font-size: 1.1rem;">Best Fit: ${data.position_fit.best_fit_position} ${this.getScoreBadge(data.position_fit.fullback_hback?.fit_score > data.position_fit.tight_end?.fit_score ? data.position_fit.fullback_hback?.fit_score : data.position_fit.tight_end?.fit_score)}</p>
                                        <p style="margin: 0;">${data.position_fit.best_fit_reasoning || ''}</p>
                                    </div>
                                    ${data.position_fit.tight_end ? `
                                        <div style="margin-bottom: 0.75rem;">
                                            <p style="margin: 0; font-weight: 600;">Tight End ${this.getScoreBadge(data.position_fit.tight_end.fit_score)} ${data.position_fit.tight_end.fit_score}/5</p>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--color-text-secondary);">Usage: ${data.position_fit.tight_end.usage_frequency} ‚Ä¢ Role: ${data.position_fit.tight_end.role_type}</p>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">${data.position_fit.tight_end.notes}</p>
                                        </div>
                                    ` : ''}
                                    ${data.position_fit.fullback_hback ? `
                                        <div>
                                            <p style="margin: 0; font-weight: 600;">Fullback/H-back ${this.getScoreBadge(data.position_fit.fullback_hback.fit_score)} ${data.position_fit.fullback_hback.fit_score}/5</p>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--color-text-secondary);">Usage: ${data.position_fit.fullback_hback.usage_frequency} ‚Ä¢ Role: ${data.position_fit.fullback_hback.role_type}</p>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">${data.position_fit.fullback_hback.notes}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}

                            ${data.scores ? `
                                <!-- Score Breakdown -->
                                <div style="background: var(--color-bg-secondary); border: 2px solid var(--color-accent-primary); border-radius: var(--border-radius); padding: 1rem;">
                                    <h3>üìä Score Breakdown</h3>
                                    ${data.scores.playing_time ? `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                                            <span>Playing Time</span>
                                            <span style="font-weight: 700;">${this.getScoreBadge(data.scores.playing_time.value)} ${data.scores.playing_time.value}/5</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin: 0.25rem 0 0.75rem 0;">${data.scores.playing_time.reasoning}</p>
                                    ` : ''}
                                    ${data.scores.position_development ? `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                                            <span>Position Development</span>
                                            <span style="font-weight: 700;">${this.getScoreBadge(data.scores.position_development.value)} ${data.scores.position_development.value}/5</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin: 0.25rem 0 0.75rem 0;">${data.scores.position_development.reasoning}</p>
                                    ` : ''}
                                    ${data.scores.transfer_pipeline ? `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                                            <span>Transfer/Advancement Pipeline</span>
                                            <span style="font-weight: 700;">${this.getScoreBadge(data.scores.transfer_pipeline.value)} ${data.scores.transfer_pipeline.value}/5</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin: 0.25rem 0 0.75rem 0;">${data.scores.transfer_pipeline.reasoning}</p>
                                    ` : ''}
                                    ${data.scores.coaching_stability ? `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                                            <span>Coaching Stability</span>
                                            <span style="font-weight: 700;">${this.getScoreBadge(data.scores.coaching_stability.value)} ${data.scores.coaching_stability.value}/5</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin: 0.25rem 0 0.75rem 0;">${data.scores.coaching_stability.reasoning}</p>
                                    ` : ''}
                                    ${data.scores.academic_fit ? `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                                            <span>Academic Fit</span>
                                            <span style="font-weight: 700;">${this.getScoreBadge(data.scores.academic_fit.value)} ${data.scores.academic_fit.value}/5</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin: 0.25rem 0 0.75rem 0;">${data.scores.academic_fit.reasoning}</p>
                                    ` : ''}
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--color-accent-primary);">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 700; font-size: 1.1rem;">Overall Score</span>
                                            <span style="font-weight: 700; font-size: 1.2rem;">${(() => {
                                                const score = this.calculateOverallScore(data);
                                                return `${this.getScoreBadge(score)} ${score.toFixed(1)}/5`;
                                            })()}</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-muted); margin: 0.25rem 0 0 0;">Weighted for ${data.level} level</p>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Financial Overview -->
                            <div style="background: var(--color-bg-secondary); border-radius: var(--border-radius); padding: 1rem;">
                                <h3>üí∞ Financial Overview</h3>
                                ${data.tuition_cost ? `<p><strong>Annual Cost:</strong> ${data.tuition_cost}</p>` : ''}
                                ${data.four_year_cost ? `<p><strong>Total Cost:</strong> ${data.four_year_cost}</p>` : ''}
                                ${data.scholarship_potential ? `<p><strong>Scholarship Potential:</strong> ${data.scholarship_potential}</p>` : ''}
                                ${data.financial_comparison ? `<p style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--color-border);"><strong>Cost Comparison & ROI:</strong><br>${data.financial_comparison}</p>` : ''}
                            </div>

                            <!-- Coaching Staff -->
                            <div style="background: var(--color-bg-secondary); border-radius: var(--border-radius); padding: 1rem;">
                                <h3>üëî Coaching Staff</h3>
                                ${data.head_coach ? `<p><strong>Head Coach:</strong> ${data.head_coach}</p>` : ''}
                                ${data.te_coach ? `<p><strong>TE Coach:</strong> ${data.te_coach}</p>` : ''}
                                ${data.recruiting_contact ? `<p><strong>Recruiting Contact:</strong> ${data.recruiting_contact}</p>` : ''}
                                ${data.phone ? `<p><strong>Phone:</strong> <a href="tel:${data.phone}" style="color: var(--color-accent-primary);">${data.phone}</a></p>` : ''}
                                ${data.email ? `<p><strong>Email:</strong> <a href="mailto:${data.email}" style="color: var(--color-accent-primary);">${data.email}</a></p>` : ''}
                                ${data.twitter ? `<p><strong>Twitter:</strong> ${data.twitter}</p>` : ''}
                            </div>

                            <!-- Program Analysis -->
                            <div style="background: var(--color-bg-secondary); border-radius: var(--border-radius); padding: 1rem;">
                                <h3>üìä Program Analysis</h3>
                                ${data.recent_record ? `<p><strong>Recent Record:</strong> ${data.recent_record}</p>` : ''}
                                ${data.program_momentum ? `<p><strong>Momentum:</strong> ${data.program_momentum}</p>` : ''}
                                ${data.te_development ? `<p><strong>TE Development:</strong> ${data.te_development}</p>` : ''}
                                ${data.transfer_pipeline ? `<p><strong>Transfer Pipeline:</strong> ${data.transfer_pipeline}</p>` : ''}
                            </div>

                            <!-- Red Flags -->
                            ${data.red_flags && data.red_flags.length > 0 ? `
                                <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-danger); border-radius: var(--border-radius); padding: 1rem;">
                                    <h3 style="color: var(--color-danger);">‚ö†Ô∏è Red Flags</h3>
                                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                                        ${data.red_flags.map(flag => `<li>${flag}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            <!-- Opportunities -->
                            ${data.opportunities && data.opportunities.length > 0 ? `
                                <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-success); border-radius: var(--border-radius); padding: 1rem;">
                                    <h3 style="color: var(--color-success);">‚úÖ Opportunities</h3>
                                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                                        ${data.opportunities.map(opp => `<li>${opp}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            <!-- Contact Strategy -->
                            ${data.contact_strategy || data.contact_script_twitter || data.contact_script_email ? `
                                <div style="background: var(--color-bg-secondary); border-radius: var(--border-radius); padding: 1rem;">
                                    <h3>üìû Contact Strategy</h3>
                                    ${data.contact_strategy ? `<p>${data.contact_strategy}</p>` : ''}

                                    ${data.contact_script_twitter ? `
                                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--color-bg-tertiary); border-radius: 4px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                <strong>Twitter DM Template:</strong>
                                                <button class="btn btn-small btn-secondary" onclick="App.API.copyToClipboard('${data.contact_script_twitter.replace(/'/g, "\\'")}', 'Twitter DM')">üìã Copy</button>
                                            </div>
                                            <p style="font-size: 0.9rem; margin: 0;">${data.contact_script_twitter}</p>
                                        </div>
                                    ` : ''}

                                    ${data.contact_script_email ? `
                                        <div style="margin-top: 1rem; padding: 0.75rem; background: var(--color-bg-tertiary); border-radius: 4px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                <strong>Email Template:</strong>
                                                <button class="btn btn-small btn-secondary" onclick="App.API.copyToClipboard(\`${data.contact_script_email.replace(/`/g, "\\`")}\`, 'Email')">üìã Copy</button>
                                            </div>
                                            <pre style="font-size: 0.85rem; margin: 0; white-space: pre-wrap; font-family: var(--font-family);">${data.contact_script_email}</pre>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}

                            <!-- JUCO Comparison (for 4-year schools) -->
                            ${data.comparison_to_juco ? `
                                <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-info); border-radius: var(--border-radius); padding: 1rem;">
                                    <h3 style="color: var(--color-info);">üîÑ vs JUCO Option</h3>
                                    <p>${data.comparison_to_juco}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    document.getElementById('research-results-content').innerHTML = html;
                    document.getElementById('research-results').classList.remove('hidden');
                },

                // Copy to clipboard
                copyToClipboard(text, label) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert(`${label} copied to clipboard!`);
                    }).catch(err => {
                        console.error('Copy failed:', err);
                        alert('Failed to copy. Please select and copy manually.');
                    });
                },

                // Save researched school to tracker
                saveResearchedSchool() {
                    if (!this.currentResearchData) {
                        alert('No research data to save');
                        return;
                    }

                    const data = this.currentResearchData;

                    // Map AI response to school schema
                    const schoolData = {
                        schoolName: data.school_name,
                        level: data.level,
                        location: data.location,
                        conference: data.conference,

                        // Coaching staff
                        headCoach: data.head_coach,
                        positionCoach: data.te_coach,
                        recruitingContact: data.recruiting_contact,
                        phone: data.phone,
                        email: data.email,
                        twitter: data.twitter,

                        // Status - set defaults
                        ourInterestLevel: data.recommendation?.includes('High Priority') ? 'High' :
                                         data.recommendation?.includes('Medium Priority') ? 'Medium' : 'Low',
                        theirInterestLevel: 'Unknown',
                        likelihood: data.overall_ranking || 'Target',
                        offerStatus: 'None',

                        // Initialize empty arrays
                        contactHistory: [],
                        actionHistory: [],

                        // Initialize ratings at 0
                        ratings: {
                            coach: 0,
                            programFit: 0,
                            financial: 0,
                            academic: 0,
                            location: 0,
                            overall: 0
                        },

                        // AI Analysis
                        aiAnalysis: {
                            recentRecord: data.recent_record,
                            tuitionCost: data.tuition_cost,
                            fourYearCost: data.four_year_cost,
                            scholarshipPotential: data.scholarship_potential,
                            programMomentum: data.program_momentum,
                            teDevelopment: data.te_development,
                            transferPipeline: data.transfer_pipeline,
                            redFlags: data.red_flags || [],
                            opportunities: data.opportunities || [],
                            financialComparison: data.financial_comparison,
                            recommendation: data.recommendation,
                            contactStrategy: data.contact_strategy,
                            contactScriptTwitter: data.contact_script_twitter,
                            contactScriptEmail: data.contact_script_email,
                            comparisonToJuco: data.comparison_to_juco,
                            positionFit: data.position_fit || null,
                            scores: data.scores || null,
                            researchDate: new Date().toISOString()
                        },

                        // Verification tracking
                        lastVerifiedDate: null,
                        manualOverrides: {
                            headCoach: false,
                            positionCoach: false,
                            recentRecord: false,
                            programMomentum: false
                        },

                        notes: `Researched with AI on ${new Date().toLocaleDateString()}`
                    };

                    // Save to storage
                    App.Storage.saveSchool(schoolData);

                    // Clear research and return to dashboard
                    this.clearResearch();
                    App.UI.showView('dashboard');

                    alert(`${data.school_name} saved to tracker!`);
                },

                // Clear research
                clearResearch() {
                    this.currentResearchData = null;
                    document.getElementById('research-input').value = '';
                    document.getElementById('research-results').classList.add('hidden');
                    document.getElementById('research-error').classList.add('hidden');
                    document.getElementById('research-loading').classList.add('hidden');
                },

                // Get score badge emoji based on numeric score
                getScoreBadge(score) {
                    if (score >= 4.0) return 'üü¢';
                    if (score >= 3.0) return 'üü°';
                    if (score >= 2.0) return 'üü†';
                    return 'üî¥';
                },

                // Calculate overall weighted score based on school level
                calculateOverallScore(data) {
                    if (!data.scores) return 0;

                    const weights = this.getWeightsByLevel(data.level);
                    const scores = data.scores;

                    const weighted = (
                        (scores.playing_time?.value || 0) * weights.playingTime +
                        (scores.position_development?.value || 0) * weights.positionDevelopment +
                        (scores.transfer_pipeline?.value || 0) * weights.transferPipeline +
                        (scores.coaching_stability?.value || 0) * weights.coaching +
                        (scores.academic_fit?.value || 0) * weights.academic
                    ) / 5;

                    return weighted;
                },

                // Get scoring weights by school level
                getWeightsByLevel(level) {
                    if (level === 'JUCO') {
                        return {
                            playingTime: 0.25,
                            positionDevelopment: 0.25,
                            transferPipeline: 0.35,
                            coaching: 0.10,
                            academic: 0.05
                        };
                    } else if (level === 'D1') {
                        return {
                            playingTime: 0.25,
                            positionDevelopment: 0.30,
                            transferPipeline: 0.10,
                            coaching: 0.20,
                            academic: 0.15
                        };
                    } else {
                        // D2, D3, NAIA
                        return {
                            playingTime: 0.30,
                            positionDevelopment: 0.30,
                            transferPipeline: 0.20,
                            coaching: 0.15,
                            academic: 0.05
                        };
                    }
                }
            },

            // ===== DISCOVER MODULE =====
            Discover: {
                currentResults: null,

                // Find schools matching criteria
                async findSchools() {
                    // Get selected levels
                    const levels = [];
                    if (document.getElementById('discover-level-juco').checked) levels.push('JUCO');
                    if (document.getElementById('discover-level-d1').checked) levels.push('D1');
                    if (document.getElementById('discover-level-d2').checked) levels.push('D2');
                    if (document.getElementById('discover-level-d3').checked) levels.push('D3');
                    if (document.getElementById('discover-level-naia').checked) levels.push('NAIA');

                    if (levels.length === 0) {
                        alert('Please select at least one school level');
                        return;
                    }

                    // Get other filters
                    const state = document.getElementById('discover-state').value;
                    const conference = document.getElementById('discover-conference').value.trim();
                    const minScore = parseFloat(document.getElementById('discover-min-score').value);

                    // Show loading state
                    document.getElementById('discover-loading').classList.remove('hidden');
                    document.getElementById('discover-error').classList.add('hidden');
                    document.getElementById('discover-results').classList.add('hidden');

                    try {
                        // Build discovery prompt
                        const prompt = this.buildDiscoveryPrompt(levels, state, conference, minScore);

                        // Call Claude API via Cloudflare Worker proxy
                        const response = await fetch('https://josephs-path-glory-proxy.dronescout-api.workers.dev', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'anthropic-version': '2023-06-01'
                            },
                            body: JSON.stringify({
                                model: 'claude-sonnet-4-20250514',
                                max_tokens: 8000,
                                messages: [{
                                    role: 'user',
                                    content: prompt
                                }]
                            })
                        });

                        if (!response.ok) {
                            const errorBody = await response.text();
                            console.error('API Error Response:', errorBody);
                            throw new Error(`API Error: ${response.status} - ${errorBody.substring(0, 200)}`);
                        }

                        const data = await response.json();
                        const aiResponse = data.content[0].text;

                        // Parse JSON response
                        let schoolsData;
                        try {
                            schoolsData = JSON.parse(aiResponse);
                        } catch (e) {
                            // Try to extract JSON if wrapped in markdown
                            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                schoolsData = JSON.parse(jsonMatch[0]);
                            } else {
                                throw new Error('Could not parse AI response as JSON');
                            }
                        }

                        // Store results
                        this.currentResults = schoolsData.schools;

                        // Hide loading, show results
                        document.getElementById('discover-loading').classList.add('hidden');
                        this.displayResults(schoolsData.schools);

                    } catch (error) {
                        console.error('Discovery error:', error);
                        document.getElementById('discover-loading').classList.add('hidden');
                        document.getElementById('discover-error').classList.remove('hidden');
                        document.getElementById('discover-error-message').textContent =
                            error.message || 'An error occurred during school discovery. Please try again.';
                    }
                },

                // Build discovery prompt using same criteria as research
                buildDiscoveryPrompt(levels, state, conference, minScore) {
                    const levelsStr = levels.join(', ');
                    const stateFilter = state ? `\n- Located in: ${state}` : '';
                    const conferenceFilter = conference ? `\n- Conference: ${conference}` : '';

                    return `You are a college football recruiting analyst with a Chief of Staff mindset. Find and rank the TOP 10 schools that best match Joseph's profile based on the filters provided.

YOUR APPROACH:
- High-impact brevity - Cut through recruiting hype, focus on facts
- Skeptical lens - Challenge assumptions, identify red flags early
- Forward-thinking - Consider Joseph's path 2-4 years out (transfer pipeline, eligibility)
- Reality-based - No aspirational thinking, only what's likely given his profile

CRITICAL CONTEXT - JOSEPH'S SITUATION:
- HS senior TE who missed junior season (injury) - LIMITED FILM
- Mid-to-low 2.X GPA, no standardized test scores - ACADEMIC RISK
- Position versatility: PRIMARY = Blocking TE/Fullback hybrid, SECONDARY = Pass catching
- Strengths: In-line blocking, lead blocking, pass protection, physicality
- Can play: In-line TE, H-back, Fullback, move TE, Y-TE (blocking emphasis)
- Needs to build more game film for transfer opportunities
- Two years of eligibility remaining (critical for 4-year vs JUCO decision)
- Current situation: 1 actual offer (Elmhurst D3), active recruiting interest from Beloit (D3) and Quincy (D2)
- Top JUCO targets: Coffeyville CC, Iowa Western CC, Hutchinson CC

SEARCH FILTERS:
- School levels: ${levelsStr}${stateFilter}${conferenceFilter}
- Minimum overall score: ${minScore}/5

ASSESSMENT PRIORITIES (DO NOT base recommendations on cost):
1. Playing time likelihood - Can Joseph realistically compete for snaps?
2. Position development - Track record developing TEs or FBs (specific examples with names/years)
3. Transfer/advancement pipeline - Where do players go next? (D1 transfers for JUCO, NFL for D1)
4. Coaching stability - Turnover, tenure, program momentum
5. Academic fit - GPA requirements, academic support for 2.X GPA student

SCORING REQUIREMENT:
For each school, provide 1-5 scores (decimals allowed) for each of the 5 assessment priorities above.

BE FACTUAL AND ANALYTICAL:
- Only recommend schools that genuinely fit Joseph's profile
- Prioritize JUCO schools with strong transfer pipelines if JUCO is selected
- For D2/D3/NAIA, prioritize playing time and position development
- Challenge recruiting narratives with evidence
- Flag red flags prominently

Provide your response in this EXACT JSON format (DO NOT include markdown code blocks, ONLY raw JSON):

{
  "search_criteria": {
    "levels": "${levelsStr}",
    "state": "${state || 'Any'}",
    "conference": "${conference || 'Any'}",
    "min_score": ${minScore}
  },
  "schools": [
    {
      "rank": 1,
      "school_name": "Full official name",
      "level": "JUCO/D1/D2/D3/NAIA",
      "location": "City, State",
      "conference": "Conference name",
      "why_ranked": ["Top 2-3 specific reasons why this school ranked #1"],
      "scores": {
        "playing_time": {
          "value": 4.5,
          "reasoning": "Brief explanation"
        },
        "position_development": {
          "value": 5.0,
          "reasoning": "Brief explanation with specific examples"
        },
        "transfer_pipeline": {
          "value": 4.8,
          "reasoning": "Brief explanation"
        },
        "coaching_stability": {
          "value": 4.2,
          "reasoning": "Brief explanation"
        },
        "academic_fit": {
          "value": 5.0,
          "reasoning": "Brief explanation"
        }
      },
      "overall_score": 4.7,
      "contact_info": {
        "head_coach": "Name",
        "recruiting_contact": "Name and role",
        "phone": "Phone number",
        "twitter": "@handle"
      }
    }
  ]
}

Return EXACTLY 10 schools ranked from best fit (#1) to 10th best fit (#10).`;
                },

                // Display discovery results
                displayResults(schools) {
                    const grid = document.getElementById('discover-results-grid');
                    grid.innerHTML = '';

                    schools.forEach(school => {
                        const card = this.createSchoolCard(school);
                        grid.appendChild(card);
                    });

                    document.getElementById('discover-results').classList.remove('hidden');
                },

                // Create individual school card
                createSchoolCard(school) {
                    const card = document.createElement('div');
                    card.style.cssText = 'background: var(--color-bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); border: 1px solid var(--color-border);';

                    const overallScore = school.overall_score || App.API.calculateOverallScore(school);
                    const badge = App.API.getScoreBadge(overallScore);

                    // Check if school already in tracker
                    const existingSchool = App.Storage.getSchools().find(s =>
                        s.name && school.school_name && s.name.toLowerCase() === school.school_name.toLowerCase()
                    );
                    const alreadyTracked = existingSchool ? '<span style="color: var(--color-text-muted); font-size: 0.85rem; margin-left: 0.5rem;">‚úì In Tracker</span>' : '';

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <span style="font-size: 1.2rem; font-weight: 600;">#${school.rank}</span>
                                    <h3 style="margin: 0; font-size: 1.1rem;">${school.school_name}</h3>
                                    ${alreadyTracked}
                                </div>
                                <div style="color: var(--color-text-secondary); font-size: 0.9rem;">
                                    ${school.level} ‚Ä¢ ${school.location} ‚Ä¢ ${school.conference}
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem;">${badge}</div>
                                <div style="font-weight: 600; font-size: 1.1rem;">${overallScore.toFixed(1)}/5</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <strong>Why This School:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${school.why_ranked.map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                        </div>

                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                            ${this.createScorePill('Playing Time', school.scores.playing_time.value)}
                            ${this.createScorePill('Position Dev', school.scores.position_development.value)}
                            ${this.createScorePill('Transfer', school.scores.transfer_pipeline.value)}
                            ${this.createScorePill('Coaching', school.scores.coaching_stability.value)}
                            ${this.createScorePill('Academic', school.scores.academic_fit.value)}
                        </div>

                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-small" onclick="App.Discover.researchSchool('${school.school_name.replace(/'/g, "\\'")}')">
                                üîç Full Research
                            </button>
                            ${!existingSchool ? `
                                <button class="btn btn-secondary btn-small" onclick="App.Discover.quickAddSchool('${school.school_name.replace(/'/g, "\\'")}')">
                                    + Quick Add
                                </button>
                            ` : ''}
                        </div>
                    `;

                    return card;
                },

                // Create score pill
                createScorePill(label, score) {
                    const badge = App.API.getScoreBadge(score);
                    return `
                        <div style="display: flex; align-items: center; gap: 0.3rem; background: var(--color-bg); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
                            <span>${badge}</span>
                            <span style="color: var(--color-text-secondary);">${label}:</span>
                            <span style="font-weight: 600;">${score.toFixed(1)}</span>
                        </div>
                    `;
                },

                // Research individual school from discovery results
                async researchSchool(schoolName) {
                    // Switch to research view
                    App.UI.showView('research');

                    // Set school name
                    document.getElementById('research-input').value = schoolName;

                    // Trigger research
                    await App.API.researchSchool();
                },

                // Quick add school without full research
                async quickAddSchool(schoolName) {
                    const school = this.currentResults.find(s => s.school_name === schoolName);
                    if (!school) return;

                    const newSchool = {
                        id: Date.now().toString(),
                        name: school.school_name,
                        level: school.level,
                        location: school.location,
                        conference: school.conference,
                        headCoach: school.contact_info?.head_coach || '',
                        teCoach: '',
                        recruitingContact: school.contact_info?.recruiting_contact || '',
                        phone: school.contact_info?.phone || '',
                        email: '',
                        twitter: school.contact_info?.twitter || '',
                        interest: 'medium',
                        status: 'researching',
                        rating: 0,
                        notes: `Discovered via AI Search (Rank #${school.rank})\n\nWhy ranked here:\n${school.why_ranked.join('\n')}`,
                        contacts: [],
                        actions: [],
                        scores: school.scores,
                        createdAt: new Date().toISOString(),
                        addedBy: App.Auth.currentUser?.email || 'Unknown'
                    };

                    // Save to storage
                    await App.Storage.addSchool(newSchool);

                    alert(`${schoolName} added to tracker!`);

                    // Refresh results to show "In Tracker" badge
                    this.displayResults(this.currentResults);
                },

                // Clear results and reset form
                clearResults() {
                    this.currentResults = null;
                    document.getElementById('discover-results').classList.add('hidden');
                    document.getElementById('discover-error').classList.add('hidden');
                }
            },

            // ===== UI MODULE =====
            UI: {
                currentView: 'dashboard',
                currentFilter: 'all',
                currentContributorFilter: 'all',
                currentStatFilter: 'all',
                currentSort: 'interest',
                searchQuery: '',
                editingSchoolId: null,
                deletingSchoolId: null,

                // Initialize UI
                init() {
                    // Navigation
                    document.querySelectorAll('.nav-btn[data-view]').forEach(btn => {
                        btn.addEventListener('click', () => {
                            this.showView(btn.dataset.view);
                        });
                    });

                    // Filter buttons
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            this.currentFilter = btn.dataset.filter;
                            this.renderSchools();
                        });
                    });

                    // Sort select
                    document.getElementById('sort-select').addEventListener('change', (e) => {
                        this.currentSort = e.target.value;
                        this.renderSchools();
                    });

                    // Contributor filter
                    document.getElementById('contributor-filter').addEventListener('change', (e) => {
                        this.currentContributorFilter = e.target.value;
                        this.renderSchools();
                    });

                    // Search input
                    document.getElementById('search-input').addEventListener('input', (e) => {
                        this.searchQuery = e.target.value.toLowerCase();
                        this.renderSchools();
                    });

                    // API Key no longer needed - stored securely in Cloudflare Worker
                    // Family members don't need to enter anything

                    // Render initial view
                    this.renderDashboard();
                },

                // Show view
                showView(viewName) {
                    // Hide all views
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

                    // Show selected view
                    document.getElementById(`${viewName}-view`).classList.add('active');

                    // Update nav buttons
                    document.querySelectorAll('.nav-btn[data-view]').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.view === viewName);
                    });

                    this.currentView = viewName;

                    // Render view content
                    if (viewName === 'dashboard') {
                        this.renderDashboard();
                    } else if (viewName === 'actions') {
                        this.renderActions();
                    } else if (viewName === 'settings') {
                        this.renderTeamInfo();
                    }
                },

                // Render team info in Settings
                renderTeamInfo() {
                    const teamSection = document.getElementById('team-info-section');
                    const teamNameEl = document.getElementById('team-name-display');
                    const teamIdEl = document.getElementById('team-id-display');

                    if (App.Team.currentTeam) {
                        teamSection.style.display = 'block';
                        teamNameEl.textContent = App.Team.currentTeam.name || 'Unnamed Team';
                        teamIdEl.textContent = App.Team.currentTeam.id;
                    } else {
                        teamSection.style.display = 'none';
                    }
                },

                // Copy Team ID to clipboard
                copyTeamId() {
                    const teamId = App.Team.currentTeam?.id;
                    if (teamId) {
                        navigator.clipboard.writeText(teamId).then(() => {
                            alert('Team ID copied to clipboard!');
                        }).catch(err => {
                            // Fallback for older browsers
                            prompt('Copy this Team ID:', teamId);
                        });
                    }
                },

                // Set stat filter (On Plate / Offers / Priority)
                setStatFilter(filter) {
                    this.currentStatFilter = filter;

                    // Update active state on stat cards
                    document.querySelectorAll('.stat-card').forEach(card => {
                        card.classList.toggle('active', card.dataset.statFilter === filter);
                    });

                    // Re-render schools with filter
                    this.renderSchools();
                },

                // Render dashboard
                renderDashboard() {
                    this.renderStats();
                    this.renderSchools();
                },

                // Render stats
                renderStats() {
                    const schools = App.Storage.getSchools();
                    const offers = schools.filter(s =>
                        s.offerStatus === 'Verbal Offer' || s.offerStatus === 'Official Offer'
                    ).length;
                    const priority = schools.filter(s => s.ourInterestLevel === 'High').length;

                    document.getElementById('stat-total').textContent = schools.length;
                    document.getElementById('stat-offers').textContent = offers;
                    document.getElementById('stat-priority').textContent = priority;
                },

                // Render schools
                renderSchools() {
                    let schools = App.Storage.getSchools();

                    // Populate contributor filter dropdown
                    this.populateContributorFilter(schools);

                    // Filter by level
                    if (this.currentFilter !== 'all') {
                        schools = schools.filter(s => s.level === this.currentFilter);
                    }

                    // Filter by contributor
                    if (this.currentContributorFilter !== 'all') {
                        schools = schools.filter(s => s.createdBy === this.currentContributorFilter);
                    }

                    // Filter by stat category (offers / priority)
                    if (this.currentStatFilter === 'offers') {
                        schools = schools.filter(s =>
                            s.offerStatus === 'Verbal Offer' || s.offerStatus === 'Official Offer'
                        );
                    } else if (this.currentStatFilter === 'priority') {
                        schools = schools.filter(s => s.ourInterestLevel === 'High');
                    }

                    // Search
                    if (this.searchQuery) {
                        schools = schools.filter(s =>
                            s.schoolName.toLowerCase().includes(this.searchQuery) ||
                            (s.location && s.location.toLowerCase().includes(this.searchQuery))
                        );
                    }

                    // Sort
                    schools = this.sortSchools(schools, this.currentSort);

                    // Render
                    const grid = document.getElementById('school-grid');
                    const emptyState = document.getElementById('empty-state');

                    if (schools.length === 0) {
                        grid.innerHTML = '';
                        emptyState.classList.remove('hidden');
                    } else {
                        emptyState.classList.add('hidden');
                        grid.innerHTML = schools.map(s => this.renderSchoolCard(s)).join('');
                    }
                },

                // Populate contributor filter dropdown
                populateContributorFilter(schools) {
                    const contributorFilter = document.getElementById('contributor-filter');
                    const currentValue = contributorFilter.value;

                    // Get unique contributors
                    const contributors = new Map();
                    schools.forEach(school => {
                        if (school.createdBy && school.createdByName) {
                            contributors.set(school.createdBy, school.createdByName);
                        }
                    });

                    // Rebuild dropdown options
                    contributorFilter.innerHTML = '<option value="all">All Contributors</option>';
                    contributors.forEach((name, email) => {
                        const option = document.createElement('option');
                        option.value = email;
                        option.textContent = name;
                        contributorFilter.appendChild(option);
                    });

                    // Restore previous selection if it still exists
                    if (currentValue && contributorFilter.querySelector(`option[value="${currentValue}"]`)) {
                        contributorFilter.value = currentValue;
                    } else {
                        contributorFilter.value = 'all';
                        this.currentContributorFilter = 'all';
                    }
                },

                // Sort schools
                sortSchools(schools, sortBy) {
                    const sorted = [...schools];

                    switch (sortBy) {
                        case 'name':
                            sorted.sort((a, b) => a.schoolName.localeCompare(b.schoolName));
                            break;
                        case 'date':
                            sorted.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
                            break;
                        case 'rating':
                            sorted.sort((a, b) => (b.ratings?.overall || 0) - (a.ratings?.overall || 0));
                            break;
                        case 'overall-score':
                            sorted.sort((a, b) => {
                                const scoreA = a.aiAnalysis?.scores ?
                                    App.API.calculateOverallScore({ level: a.level, scores: a.aiAnalysis.scores }) : 0;
                                const scoreB = b.aiAnalysis?.scores ?
                                    App.API.calculateOverallScore({ level: b.level, scores: b.aiAnalysis.scores }) : 0;
                                return scoreB - scoreA;
                            });
                            break;
                        case 'playing-time':
                            sorted.sort((a, b) =>
                                (b.aiAnalysis?.scores?.playing_time?.value || 0) - (a.aiAnalysis?.scores?.playing_time?.value || 0)
                            );
                            break;
                        case 'position-dev':
                            sorted.sort((a, b) =>
                                (b.aiAnalysis?.scores?.position_development?.value || 0) - (a.aiAnalysis?.scores?.position_development?.value || 0)
                            );
                            break;
                        case 'transfer':
                            sorted.sort((a, b) =>
                                (b.aiAnalysis?.scores?.transfer_pipeline?.value || 0) - (a.aiAnalysis?.scores?.transfer_pipeline?.value || 0)
                            );
                            break;
                        case 'coaching':
                            sorted.sort((a, b) =>
                                (b.aiAnalysis?.scores?.coaching_stability?.value || 0) - (a.aiAnalysis?.scores?.coaching_stability?.value || 0)
                            );
                            break;
                        case 'academic':
                            sorted.sort((a, b) =>
                                (b.aiAnalysis?.scores?.academic_fit?.value || 0) - (a.aiAnalysis?.scores?.academic_fit?.value || 0)
                            );
                            break;
                        case 'interest':
                        default:
                            const interestOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                            sorted.sort((a, b) =>
                                (interestOrder[b.ourInterestLevel] || 0) - (interestOrder[a.ourInterestLevel] || 0)
                            );
                    }

                    return sorted;
                },

                // Render school card
                renderSchoolCard(school) {
                    const levelClass = `badge-${school.level.toLowerCase().replace(/\s/g, '-')}`;
                    const likelihoodClass = `badge-${school.likelihood?.toLowerCase() || 'target'}`;
                    const rating = school.ratings?.overall || 0;
                    const nextAction = school.nextAction || 'No action set';

                    // Calculate overall score if AI data exists
                    let overallScore = 0;
                    let scoreBadge = '';
                    if (school.aiAnalysis?.scores) {
                        overallScore = App.API.calculateOverallScore({
                            level: school.level,
                            scores: school.aiAnalysis.scores
                        });
                        scoreBadge = App.API.getScoreBadge(overallScore);
                    }

                    // Get best fit position
                    const bestFitPosition = school.aiAnalysis?.positionFit?.best_fit_position || null;

                    return `
                        <div class="school-card" onclick="App.UI.showSchoolDetail('${school.id}')">
                            <div class="school-card-header">
                                <div class="school-name">${school.schoolName} ${this.getVerificationBadge(school)}</div>
                                ${rating > 0 ? `<div class="school-rating">‚≠ê ${rating.toFixed(1)}</div>` : ''}
                            </div>

                            ${overallScore > 0 ? `
                                <div class="school-meta" style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-weight: bold;">${scoreBadge} ${overallScore.toFixed(1)}</span> Overall Score
                                    ${bestFitPosition ? ` ‚Ä¢ Best: ${bestFitPosition}` : ''}
                                </div>
                            ` : ''}

                            <div class="school-meta">
                                <span class="school-badge ${levelClass}">${school.level}</span>
                                ${school.likelihood ? `<span class="school-badge ${likelihoodClass}">${school.likelihood}</span>` : ''}
                            </div>
                            <div class="school-meta">${school.location || 'Location not set'}</div>
                            ${school.createdByName ? `<div class="school-meta" style="font-size: 0.8em; opacity: 0.7;">Added by ${school.createdByName}</div>` : ''}
                            ${school.offerStatus && school.offerStatus !== 'None' ?
                                `<div class="school-meta text-success">üìã ${school.offerStatus}</div>` : ''}
                            <div class="school-action">
                                Next: ${nextAction}
                            </div>
                        </div>
                    `;
                },

                // Show school detail
                showSchoolDetail(schoolId) {
                    const school = App.Storage.getSchool(schoolId);
                    if (!school) return;

                    this.editingSchoolId = schoolId;

                    const content = `
                        <div class="school-card-header">
                            <div class="school-name">${school.schoolName}</div>
                        </div>
                        <div class="school-meta mb-2">
                            <span class="school-badge badge-${school.level.toLowerCase()}">${school.level}</span>
                            ${school.likelihood ? `<span class="school-badge badge-${school.likelihood.toLowerCase()}">${school.likelihood}</span>` : ''}
                        </div>

                        ${this.renderVerificationWarning(school)}

                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="App.UI.showVerifyModal('${schoolId}')">üîç Verify & Update</button>
                            <button class="btn btn-secondary" onclick="App.UI.editSchool('${schoolId}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="App.UI.deleteSchool('${schoolId}')">üóëÔ∏è Delete</button>
                        </div>

                        <!-- Tabs -->
                        <div class="tabs">
                            <button class="tab-btn active" data-tab="overview">Overview</button>
                            <button class="tab-btn" data-tab="contacts">Contacts</button>
                            <button class="tab-btn" data-tab="actions">Actions</button>
                            <button class="tab-btn" data-tab="activity">Activity</button>
                            <button class="tab-btn" data-tab="ai">AI Analysis</button>
                        </div>

                        <!-- Tab: Overview -->
                        <div class="tab-content active" data-tab="overview">
                            ${this.renderOverviewTab(school)}
                        </div>

                        <!-- Tab: Contacts -->
                        <div class="tab-content" data-tab="contacts">
                            ${this.renderContactsTab(school)}
                        </div>

                        <!-- Tab: Actions -->
                        <div class="tab-content" data-tab="actions">
                            ${this.renderActionsTab(school)}
                        </div>

                        <!-- Tab: Activity -->
                        <div class="tab-content" data-tab="activity">
                            ${this.renderActivityTab(school)}
                        </div>

                        <!-- Tab: AI Analysis -->
                        <div class="tab-content" data-tab="ai">
                            ${this.renderAITab(school)}
                        </div>
                    `;

                    document.getElementById('detail-content').innerHTML = content;

                    // Tab switching
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                            btn.classList.add('active');
                            document.querySelector(`.tab-content[data-tab="${btn.dataset.tab}"]`).classList.add('active');
                        });
                    });

                    this.showView('detail');
                },

                // Render verification warning
                renderVerificationWarning(school) {
                    const researchDate = school.aiAnalysis?.researchDate;
                    const verifiedDate = school.lastVerifiedDate;

                    if (!researchDate) return ''; // No AI data, no warning needed

                    const now = new Date();
                    const research = new Date(researchDate);
                    const daysSinceResearch = Math.floor((now - research) / (1000 * 60 * 60 * 24));

                    let warningClass = '';
                    let warningIcon = '';
                    let warningMessage = '';

                    if (verifiedDate) {
                        const verified = new Date(verifiedDate);
                        const daysSinceVerification = Math.floor((now - verified) / (1000 * 60 * 60 * 24));

                        if (daysSinceVerification <= 30) {
                            warningClass = 'text-success';
                            warningIcon = '‚úÖ';
                            warningMessage = `Data verified ${App.Utils.formatDate(verifiedDate)}`;
                        } else if (daysSinceVerification <= 90) {
                            warningClass = 'text-warning';
                            warningIcon = '‚ö†Ô∏è';
                            warningMessage = `Last verified ${daysSinceVerification} days ago. Consider re-verifying coaching staff and current season info.`;
                        } else {
                            warningClass = 'text-danger';
                            warningIcon = 'üî¥';
                            warningMessage = `Data hasn't been verified in ${daysSinceVerification} days. Coaching staff and season info likely outdated.`;
                        }
                    } else if (daysSinceResearch > 30) {
                        warningClass = 'text-warning';
                        warningIcon = '‚ö†Ô∏è';
                        warningMessage = `AI data from ${App.Utils.formatDate(researchDate)}. Coaching staff and current season info may be outdated. Click "Verify & Update" to confirm current details.`;
                    } else {
                        return ''; // Recent research, not verified yet, but fresh enough
                    }

                    return `
                        <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-${warningClass === 'text-success' ? 'success' : warningClass === 'text-danger' ? 'danger' : 'warning'}); border-radius: var(--border-radius); padding: 0.75rem; margin-bottom: 1rem;">
                            <p class="${warningClass}" style="margin: 0;"><strong>${warningIcon} ${warningMessage}</strong></p>
                        </div>
                    `;
                },

                // Get verification badge for school card
                getVerificationBadge(school) {
                    const verifiedDate = school.lastVerifiedDate;

                    if (!verifiedDate) {
                        return '<span style="font-size: 0.75rem; color: var(--color-text-muted);">‚ö†Ô∏è AI</span>';
                    }

                    const now = new Date();
                    const verified = new Date(verifiedDate);
                    const daysSince = Math.floor((now - verified) / (1000 * 60 * 60 * 24));

                    if (daysSince <= 30) {
                        return '<span style="font-size: 0.75rem; color: var(--color-success);">‚úÖ</span>';
                    } else if (daysSince <= 90) {
                        return '<span style="font-size: 0.75rem; color: var(--color-warning);">‚ö†Ô∏è</span>';
                    } else {
                        return '<span style="font-size: 0.75rem; color: var(--color-danger);">üî¥</span>';
                    }
                },

                // Show verify modal
                showVerifyModal(schoolId) {
                    const school = App.Storage.getSchool(schoolId);
                    if (!school) return;

                    document.getElementById('verify-school-id').value = schoolId;
                    document.getElementById('verify-head-coach').value = school.headCoach || '';
                    document.getElementById('verify-te-coach').value = school.positionCoach || '';
                    document.getElementById('verify-recruiting-contact').value = school.recruitingContact || '';
                    document.getElementById('verify-phone').value = school.phone || '';
                    document.getElementById('verify-email').value = school.email || '';
                    document.getElementById('verify-twitter').value = school.twitter || '';
                    document.getElementById('verify-recent-record').value = school.aiAnalysis?.recentRecord || '';
                    document.getElementById('verify-program-momentum').value = school.aiAnalysis?.programMomentum?.split(' ')[0] || '';

                    this.openModal('verify-modal');
                },

                // Save verification
                saveVerification() {
                    const schoolId = document.getElementById('verify-school-id').value;
                    const school = App.Storage.getSchool(schoolId);
                    if (!school) return;

                    // Get form values
                    const headCoach = document.getElementById('verify-head-coach').value.trim();
                    const teCoach = document.getElementById('verify-te-coach').value.trim();
                    const recruitingContact = document.getElementById('verify-recruiting-contact').value.trim();
                    const phone = document.getElementById('verify-phone').value.trim();
                    const email = document.getElementById('verify-email').value.trim();
                    const twitter = document.getElementById('verify-twitter').value.trim();
                    const recentRecord = document.getElementById('verify-recent-record').value.trim();
                    const programMomentum = document.getElementById('verify-program-momentum').value;

                    // Update school data
                    const updated = {
                        ...school,
                        headCoach,
                        positionCoach: teCoach,
                        recruitingContact,
                        phone,
                        email,
                        twitter,
                        lastVerifiedDate: new Date().toISOString(),
                        manualOverrides: {
                            headCoach: headCoach !== school.headCoach,
                            positionCoach: teCoach !== school.positionCoach,
                            recentRecord: recentRecord !== school.aiAnalysis?.recentRecord,
                            programMomentum: programMomentum && programMomentum !== school.aiAnalysis?.programMomentum?.split(' ')[0]
                        }
                    };

                    // Update AI analysis if present
                    if (updated.aiAnalysis) {
                        if (recentRecord) {
                            updated.aiAnalysis.recentRecord = recentRecord;
                        }
                        if (programMomentum) {
                            updated.aiAnalysis.programMomentum = programMomentum;
                        }
                    }

                    // Save
                    App.Storage.saveSchool(updated);

                    // Close modal and refresh detail view
                    this.closeModal('verify-modal');
                    this.showSchoolDetail(schoolId);

                    alert('‚úÖ School data verified and updated!');
                },

                // Render Overview Tab
                renderOverviewTab(school) {
                    return `
                        <h3>Status</h3>
                        <p><strong>Our Interest:</strong> ${school.ourInterestLevel || 'Not set'}</p>
                        <p><strong>Their Interest:</strong> ${school.theirInterestLevel || 'Unknown'}</p>
                        <p><strong>Likelihood:</strong> ${school.likelihood || 'Not set'}</p>
                        <p><strong>Offer Status:</strong> ${school.offerStatus || 'None'}</p>

                        ${school.aiAnalysis?.scores ? `
                            <div class="overall-rating mt-2" style="background: var(--color-bg-tertiary); border: 2px solid var(--color-border); margin-bottom: 1rem;">
                                <div class="value">${(() => {
                                    const score = App.API.calculateOverallScore({ level: school.level, scores: school.aiAnalysis.scores });
                                    return `${App.API.getScoreBadge(score)} ${score.toFixed(1)}`;
                                })()}</div>
                                <div class="label">AI Overall Score</div>
                            </div>
                            ${school.aiAnalysis.positionFit ? `
                                <p style="text-align: center; margin-top: 0.5rem; font-weight: 600;">Best Fit: ${school.aiAnalysis.positionFit.best_fit_position}</p>
                            ` : ''}
                        ` : ''}

                        ${school.ratings ? `
                            <div class="overall-rating mt-2">
                                <div class="value">${school.ratings.overall.toFixed(1)}</div>
                                <div class="label">Manual Rating</div>
                            </div>
                            <div class="rating-group">
                                <div class="rating-row">
                                    <span class="rating-label">Coaching:</span>
                                    <span>${'‚≠ê'.repeat(school.ratings.coach || 0)}</span>
                                </div>
                                <div class="rating-row">
                                    <span class="rating-label">Program Fit:</span>
                                    <span>${'‚≠ê'.repeat(school.ratings.programFit || 0)}</span>
                                </div>
                                <div class="rating-row">
                                    <span class="rating-label">Financial:</span>
                                    <span>${'‚≠ê'.repeat(school.ratings.financial || 0)}</span>
                                </div>
                                <div class="rating-row">
                                    <span class="rating-label">Academic:</span>
                                    <span>${'‚≠ê'.repeat(school.ratings.academic || 0)}</span>
                                </div>
                                <div class="rating-row">
                                    <span class="rating-label">Location:</span>
                                    <span>${'‚≠ê'.repeat(school.ratings.location || 0)}</span>
                                </div>
                            </div>
                        ` : !school.aiAnalysis?.scores ? '<p class="text-muted">No ratings yet. Edit school to add ratings or use AI Research.</p>' : ''}

                        <h3 class="mt-2">Next Action</h3>
                        <p>${school.nextAction || 'No action set'}</p>
                        ${school.actionOwner ? `<p><strong>Owner:</strong> ${school.actionOwner}</p>` : ''}
                        ${school.actionDueDate ? `<p><strong>Due:</strong> ${App.Utils.formatDate(school.actionDueDate)}</p>` : ''}

                        ${school.notes ? `
                            <h3 class="mt-2">Notes</h3>
                            <p>${school.notes}</p>
                        ` : ''}
                    `;
                },

                // Render Contacts Tab
                renderContactsTab(school) {
                    return `
                        <h3>Staff Information</h3>
                        ${school.headCoach ? `<p><strong>Head Coach:</strong> ${school.headCoach}</p>` : ''}
                        ${school.positionCoach ? `<p><strong>TE Coach:</strong> ${school.positionCoach}</p>` : ''}
                        ${school.recruitingContact ? `<p><strong>Recruiting Contact:</strong> ${school.recruitingContact}</p>` : ''}
                        ${school.phone ? `<p><strong>Phone:</strong> <a href="tel:${school.phone}">${school.phone}</a></p>` : ''}
                        ${school.email ? `<p><strong>Email:</strong> <a href="mailto:${school.email}">${school.email}</a></p>` : ''}
                        ${school.twitter ? `<p><strong>Twitter:</strong> ${school.twitter}</p>` : ''}

                        <h3 class="mt-2">Contact History</h3>
                        ${school.contactHistory && school.contactHistory.length > 0 ?
                            school.contactHistory.map(c => `
                                <div class="history-item">
                                    <div class="history-header">
                                        <span class="history-date">${App.Utils.formatDate(c.date)}</span>
                                        <span class="history-method">${c.method}</span>
                                    </div>
                                    <p><strong>By:</strong> ${c.initiatedBy}</p>
                                    <p class="history-notes">${c.notes}</p>
                                    ${c.response ? `<p><strong>Response:</strong> ${c.response}</p>` : ''}
                                </div>
                            `).join('') :
                            '<p class="text-muted">No contact history yet.</p>'
                        }
                        <p class="text-muted mt-2">Edit school to add contact entries (Phase 3 will add quick-add form).</p>
                    `;
                },

                // Render Actions Tab
                renderActionsTab(school) {
                    // Ensure migration
                    this.migrateSchoolActions(school);

                    const pending = school.actions ? school.actions.filter(a => a.status !== 'Complete') : [];
                    const completed = school.actions ? school.actions.filter(a => a.status === 'Complete') : [];

                    // Sort pending: overdue first, then by due date
                    pending.sort((a, b) => {
                        const aOverdue = this.isOverdue(a.dueDate);
                        const bOverdue = this.isOverdue(b.dueDate);
                        if (aOverdue && !bOverdue) return -1;
                        if (!aOverdue && bOverdue) return 1;
                        if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
                        return 0;
                    });

                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Pending Actions (${pending.length})</h3>
                            <button class="btn btn-primary btn-sm" onclick="App.UI.showAddActionForSchool('${school.id}')">+ Add Action</button>
                        </div>
                        ${pending.length > 0 ? pending.map(action => {
                            const isOverdue = this.isOverdue(action.dueDate);
                            return `
                                <div class="history-item" style="cursor: pointer; ${isOverdue ? 'border-left: 4px solid var(--color-danger); background: rgba(230, 57, 70, 0.1);' : ''}" onclick="App.UI.editActionForSchool('${school.id}', '${action.id}')">
                                    <p><strong>${action.action}</strong></p>
                                    ${action.owner ? `<p><strong>Owner:</strong> ${action.owner}</p>` : ''}
                                    ${action.dueDate ? `
                                        <p>
                                            <strong>Due:</strong> ${App.Utils.formatDate(action.dueDate)}
                                            ${isOverdue ? '<span style="color: var(--color-danger); font-weight: bold; margin-left: 0.5rem;">‚ö†Ô∏è OVERDUE</span>' : ''}
                                        </p>
                                    ` : ''}
                                    <p class="text-muted" style="font-size: 0.8rem; margin-top: 0.5rem;">
                                        ${action.createdAt ? `Added: ${App.Utils.formatDate(action.createdAt)}` : ''}
                                        ${action.modifiedAt && action.modifiedAt !== action.createdAt ?
                                            ` ¬∑ Modified: ${App.Utils.formatDate(action.modifiedAt)}` : ''}
                                    </p>
                                    <p class="text-muted" style="font-size: 0.75rem;">Click to edit</p>
                                </div>
                            `;
                        }).join('') : '<p class="text-muted">No pending actions.</p>'}

                        <h3 class="mt-2">Completed Actions (${completed.length})</h3>
                        ${completed.length > 0 ? completed.map(action => `
                            <div class="history-item" style="cursor: pointer;" onclick="App.UI.editActionForSchool('${school.id}', '${action.id}')">
                                <p><strong>${action.action}</strong></p>
                                ${action.owner ? `<p><strong>Owner:</strong> ${action.owner}</p>` : ''}
                                ${action.completedAt ? `<p><strong>Completed:</strong> ${App.Utils.formatDate(action.completedAt)}</p>` : ''}
                                <p class="text-muted" style="font-size: 0.75rem;">Click to edit</p>
                            </div>
                        `).join('') : '<p class="text-muted">No completed actions yet.</p>'}
                    `;
                },

                // Render Activity Tab (action history/audit log)
                renderActivityTab(school) {
                    this.migrateSchoolActions(school);

                    const history = school.actionHistory || [];

                    // Sort by timestamp, newest first
                    const sortedHistory = [...history].sort((a, b) =>
                        new Date(b.timestamp) - new Date(a.timestamp)
                    );

                    const getActivityIcon = (type) => {
                        switch(type) {
                            case 'added': return '‚ûï';
                            case 'completed': return '‚úÖ';
                            case 'modified': return '‚úèÔ∏è';
                            case 'replaced': return 'üîÑ';
                            case 'deleted': return 'üóëÔ∏è';
                            case 'migrated': return 'üì¶';
                            default: return 'üìù';
                        }
                    };

                    const getActivityLabel = (type) => {
                        switch(type) {
                            case 'added': return 'Added';
                            case 'completed': return 'Completed';
                            case 'modified': return 'Modified';
                            case 'replaced': return 'Replaced';
                            case 'deleted': return 'Deleted';
                            case 'migrated': return 'Migrated from old system';
                            default: return type;
                        }
                    };

                    const getActivityColor = (type) => {
                        switch(type) {
                            case 'added': return 'var(--color-success)';
                            case 'completed': return 'var(--color-success)';
                            case 'deleted': return 'var(--color-danger)';
                            case 'replaced': return 'var(--color-warning, #f39c12)';
                            default: return 'var(--color-text-secondary)';
                        }
                    };

                    return `
                        <h3>Activity History</h3>
                        <p class="text-muted" style="margin-bottom: 1rem;">Complete log of all action changes for this school.</p>
                        ${sortedHistory.length > 0 ? sortedHistory.map(entry => `
                            <div class="history-item" style="border-left: 4px solid ${getActivityColor(entry.type)};">
                                <p style="margin: 0 0 0.25rem 0;">
                                    <span style="font-size: 1.1rem; margin-right: 0.5rem;">${getActivityIcon(entry.type)}</span>
                                    <strong style="color: ${getActivityColor(entry.type)};">${getActivityLabel(entry.type)}</strong>
                                </p>
                                <p style="margin: 0.25rem 0;"><strong>Action:</strong> ${entry.action}</p>
                                ${entry.oldAction ? `<p style="margin: 0.25rem 0; font-size: 0.9rem;" class="text-muted">Replaced: "${entry.oldAction}"</p>` : ''}
                                <p class="text-muted" style="font-size: 0.8rem; margin: 0.5rem 0 0 0;">
                                    ${App.Utils.formatDate(entry.timestamp)} ¬∑ By: ${entry.by || 'Unknown'}
                                </p>
                            </div>
                        `).join('') : '<p class="text-muted">No activity recorded yet. Actions and changes will appear here.</p>'}
                    `;
                },

                // Render AI Tab
                renderAITab(school) {
                    if (school.aiAnalysis) {
                        const ai = school.aiAnalysis;
                        return `
                            ${ai.positionFit ? `
                                <!-- Position Fit Assessment -->
                                <div style="background: var(--color-bg-secondary); border: 2px solid var(--color-accent-primary); border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1.5rem;">
                                    <h3>üìç Position Fit Assessment</h3>
                                    <div style="background: var(--color-bg-tertiary); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                        <p style="margin: 0 0 0.5rem 0; font-weight: 700; font-size: 1.1rem;">Best Fit: ${ai.positionFit.best_fit_position} ${App.API.getScoreBadge(ai.positionFit.fullback_hback?.fit_score > ai.positionFit.tight_end?.fit_score ? ai.positionFit.fullback_hback?.fit_score : ai.positionFit.tight_end?.fit_score)}</p>
                                        <p style="margin: 0;">${ai.positionFit.best_fit_reasoning || ''}</p>
                                    </div>
                                    ${ai.positionFit.tight_end ? `
                                        <div style="margin-bottom: 0.75rem;">
                                            <p style="margin: 0; font-weight: 600;">Tight End ${App.API.getScoreBadge(ai.positionFit.tight_end.fit_score)} ${ai.positionFit.tight_end.fit_score}/5</p>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--color-text-secondary);">Usage: ${ai.positionFit.tight_end.usage_frequency} ‚Ä¢ Role: ${ai.positionFit.tight_end.role_type}</p>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">${ai.positionFit.tight_end.notes}</p>
                                        </div>
                                    ` : ''}
                                    ${ai.positionFit.fullback_hback ? `
                                        <div>
                                            <p style="margin: 0; font-weight: 600;">Fullback/H-back ${App.API.getScoreBadge(ai.positionFit.fullback_hback.fit_score)} ${ai.positionFit.fullback_hback.fit_score}/5</p>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--color-text-secondary);">Usage: ${ai.positionFit.fullback_hback.usage_frequency} ‚Ä¢ Role: ${ai.positionFit.fullback_hback.role_type}</p>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">${ai.positionFit.fullback_hback.notes}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}

                            ${ai.scores ? `
                                <!-- Score Breakdown -->
                                <div style="background: var(--color-bg-secondary); border: 2px solid var(--color-accent-primary); border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1.5rem;">
                                    <h3>üìä Score Breakdown</h3>
                                    ${ai.scores.playing_time ? `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                                            <span>Playing Time</span>
                                            <span style="font-weight: 700;">${App.API.getScoreBadge(ai.scores.playing_time.value)} ${ai.scores.playing_time.value}/5</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin: 0.25rem 0 0.75rem 0;">${ai.scores.playing_time.reasoning}</p>
                                    ` : ''}
                                    ${ai.scores.position_development ? `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                                            <span>Position Development</span>
                                            <span style="font-weight: 700;">${App.API.getScoreBadge(ai.scores.position_development.value)} ${ai.scores.position_development.value}/5</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin: 0.25rem 0 0.75rem 0;">${ai.scores.position_development.reasoning}</p>
                                    ` : ''}
                                    ${ai.scores.transfer_pipeline ? `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                                            <span>Transfer/Advancement Pipeline</span>
                                            <span style="font-weight: 700;">${App.API.getScoreBadge(ai.scores.transfer_pipeline.value)} ${ai.scores.transfer_pipeline.value}/5</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin: 0.25rem 0 0.75rem 0;">${ai.scores.transfer_pipeline.reasoning}</p>
                                    ` : ''}
                                    ${ai.scores.coaching_stability ? `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                                            <span>Coaching Stability</span>
                                            <span style="font-weight: 700;">${App.API.getScoreBadge(ai.scores.coaching_stability.value)} ${ai.scores.coaching_stability.value}/5</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin: 0.25rem 0 0.75rem 0;">${ai.scores.coaching_stability.reasoning}</p>
                                    ` : ''}
                                    ${ai.scores.academic_fit ? `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                                            <span>Academic Fit</span>
                                            <span style="font-weight: 700;">${App.API.getScoreBadge(ai.scores.academic_fit.value)} ${ai.scores.academic_fit.value}/5</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-secondary); margin: 0.25rem 0 0.75rem 0;">${ai.scores.academic_fit.reasoning}</p>
                                    ` : ''}
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--color-accent-primary);">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 700; font-size: 1.1rem;">Overall Score</span>
                                            <span style="font-weight: 700; font-size: 1.2rem;">${(() => {
                                                const score = App.API.calculateOverallScore({ level: school.level, scores: ai.scores });
                                                return `${App.API.getScoreBadge(score)} ${score.toFixed(1)}/5`;
                                            })()}</span>
                                        </div>
                                        <p style="font-size: 0.85rem; color: var(--color-text-muted); margin: 0.25rem 0 0 0;">Weighted for ${school.level} level</p>
                                    </div>
                                </div>
                            ` : ''}

                            <h3>Program Analysis</h3>
                            ${ai.recentRecord ? `<p><strong>Recent Record:</strong> ${ai.recentRecord}</p>` : ''}
                            ${ai.programMomentum ? `<p><strong>Momentum:</strong> ${ai.programMomentum}</p>` : ''}
                            ${ai.teDevelopment ? `<p><strong>TE Development:</strong> ${ai.teDevelopment}</p>` : ''}
                            ${ai.transferPipeline ? `<p><strong>Transfer Pipeline:</strong> ${ai.transferPipeline}</p>` : ''}

                            <h3 class="mt-2">Financial</h3>
                            ${ai.tuitionCost ? `<p><strong>Annual Cost:</strong> ${ai.tuitionCost}</p>` : ''}
                            ${ai.fourYearCost ? `<p><strong>Total Cost:</strong> ${ai.fourYearCost}</p>` : ''}
                            ${ai.scholarshipPotential ? `<p><strong>Scholarship Potential:</strong> ${ai.scholarshipPotential}</p>` : ''}
                            ${ai.financialComparison ? `<p><strong>Cost Comparison:</strong> ${ai.financialComparison}</p>` : ''}

                            ${ai.redFlags && ai.redFlags.length > 0 ? `
                                <h3 class="mt-2">‚ö†Ô∏è Red Flags</h3>
                                <ul>
                                    ${ai.redFlags.map(f => `<li>${f}</li>`).join('')}
                                </ul>
                            ` : ''}

                            ${ai.opportunities && ai.opportunities.length > 0 ? `
                                <h3 class="mt-2">‚úÖ Opportunities</h3>
                                <ul>
                                    ${ai.opportunities.map(o => `<li>${o}</li>`).join('')}
                                </ul>
                            ` : ''}

                            ${ai.recommendation ? `
                                <h3 class="mt-2">Recommendation</h3>
                                <p style="color: var(--color-accent-secondary); font-weight: 700;">${ai.recommendation}</p>
                            ` : ''}

                            ${ai.comparisonToJuco ? `
                                <h3 class="mt-2">vs JUCO Option</h3>
                                <p>${ai.comparisonToJuco}</p>
                            ` : ''}
                        `;
                    } else {
                        return `
                            <div class="empty-state">
                                <div class="empty-icon">ü§ñ</div>
                                <div class="empty-message">No AI analysis yet</div>
                                <p class="text-muted">Use AI Research to analyze this school</p>
                            </div>
                        `;
                    }
                },

                // Check if action is overdue
                isOverdue(dueDate) {
                    if (!dueDate) return false;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const due = new Date(dueDate);
                    return due < today;
                },

                // Render Actions View
                renderActions() {
                    const schools = App.Storage.getSchools();
                    let allActions = [];

                    // Migrate and collect all actions
                    schools.forEach(school => {
                        this.migrateSchoolActions(school);
                        if (school.actions && school.actions.length > 0) {
                            school.actions.forEach(action => {
                                allActions.push({
                                    schoolId: school.id,
                                    actionId: action.id,
                                    school: school.schoolName,
                                    action: action.action,
                                    owner: action.owner || 'Not assigned',
                                    dueDate: action.dueDate,
                                    status: action.status || 'Pending',
                                    isOverdue: this.isOverdue(action.dueDate) && action.status !== 'Complete',
                                    createdAt: action.createdAt,
                                    modifiedAt: action.modifiedAt,
                                    completedAt: action.completedAt
                                });
                            });
                        }
                    });

                    // Populate school filter dropdown
                    const schoolFilter = document.getElementById('action-filter-school');
                    if (schoolFilter) {
                        const currentValue = schoolFilter.value;
                        schoolFilter.innerHTML = '<option value="all">All Schools</option>';
                        const schoolsWithActions = [...new Set(allActions.map(a => a.schoolId))];
                        schools.sort((a, b) => a.schoolName.localeCompare(b.schoolName)).forEach(s => {
                            if (schoolsWithActions.includes(s.id)) {
                                const option = document.createElement('option');
                                option.value = s.id;
                                option.textContent = s.schoolName;
                                if (s.id === currentValue) option.selected = true;
                                schoolFilter.appendChild(option);
                            }
                        });
                    }

                    // Get filter values
                    const statusFilter = document.getElementById('action-filter-status')?.value || 'all';
                    const ownerFilter = document.getElementById('action-filter-owner')?.value || 'all';
                    const schoolFilterValue = document.getElementById('action-filter-school')?.value || 'all';

                    // Apply filters
                    let filteredActions = allActions;
                    if (statusFilter === 'Pending') {
                        filteredActions = filteredActions.filter(a => a.status === 'Pending');
                    } else if (statusFilter === 'Complete') {
                        filteredActions = filteredActions.filter(a => a.status === 'Complete');
                    } else if (statusFilter === 'overdue') {
                        filteredActions = filteredActions.filter(a => a.isOverdue && a.status === 'Pending');
                    }
                    if (ownerFilter !== 'all') {
                        filteredActions = filteredActions.filter(a => a.owner === ownerFilter);
                    }
                    if (schoolFilterValue !== 'all') {
                        filteredActions = filteredActions.filter(a => a.schoolId === schoolFilterValue);
                    }

                    const pending = filteredActions.filter(a => a.status === 'Pending');
                    const completed = filteredActions.filter(a => a.status === 'Complete');
                    const overdue = pending.filter(a => a.isOverdue);

                    // Sort pending: overdue first, then by due date
                    pending.sort((a, b) => {
                        if (a.isOverdue && !b.isOverdue) return -1;
                        if (!a.isOverdue && b.isOverdue) return 1;
                        if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
                        return 0;
                    });

                    const overdueLabel = overdue.length > 0 ? ` <span style="color: var(--color-danger); font-weight: bold;">(${overdue.length} overdue)</span>` : '';

                    const content = `
                        <h3>Pending Actions (${pending.length})${overdueLabel}</h3>
                        ${pending.length > 0 ? pending.map(a => `
                            <div class="history-item" style="cursor: pointer; ${a.isOverdue ? 'border-left: 4px solid var(--color-danger); background: rgba(230, 57, 70, 0.1);' : ''}" onclick="App.UI.editActionForSchool('${a.schoolId}', '${a.actionId}')">
                                <p><strong>${a.school}</strong></p>
                                <p>${a.action}</p>
                                <p><strong>Owner:</strong> ${a.owner}</p>
                                ${a.dueDate ? `
                                    <p>
                                        <strong>Due:</strong> ${App.Utils.formatDate(a.dueDate)}
                                        ${a.isOverdue ? '<span style="color: var(--color-danger); font-weight: bold; margin-left: 0.5rem;">‚ö†Ô∏è OVERDUE</span>' : ''}
                                    </p>
                                ` : ''}
                                <p class="text-muted" style="font-size: 0.8rem; margin-top: 0.5rem;">
                                    ${a.createdAt ? `Added: ${App.Utils.formatDate(a.createdAt)}` : ''}
                                    ${a.modifiedAt && a.modifiedAt !== a.createdAt ? ` ¬∑ Modified: ${App.Utils.formatDate(a.modifiedAt)}` : ''}
                                </p>
                                <p class="text-muted" style="font-size: 0.75rem;">Click to edit</p>
                            </div>
                        `).join('') : '<p class="text-muted">No pending actions.</p>'}

                        <h3 class="mt-2">Completed Actions (${completed.length})</h3>
                        ${completed.length > 0 ? completed.map(a => `
                            <div class="history-item" style="cursor: pointer;" onclick="App.UI.editActionForSchool('${a.schoolId}', '${a.actionId}')">
                                <p><strong>${a.school}</strong></p>
                                <p>${a.action}</p>
                                ${a.completedAt ? `<p><strong>Completed:</strong> ${App.Utils.formatDate(a.completedAt)}</p>` : ''}
                                <p class="text-muted" style="font-size: 0.75rem;">Click to edit</p>
                            </div>
                        `).join('') : '<p class="text-muted">No completed actions yet.</p>'}
                    `;

                    document.getElementById('actions-content').innerHTML = content;
                },

                // Currently editing action ID (for edit mode)
                editingActionId: null,

                // Edit action for a specific school and action (opens edit action modal)
                editActionForSchool(schoolId, actionId = null) {
                    const school = App.Storage.getSchool(schoolId);
                    if (!school) return;

                    // Migrate if needed
                    this.migrateSchoolActions(school);

                    // Find the action to edit
                    let action = null;
                    if (actionId) {
                        action = school.actions.find(a => a.id === actionId);
                    } else if (school.actions.length > 0) {
                        action = school.actions[0]; // Default to first action
                    }

                    if (!action) {
                        alert('No action found to edit.');
                        return;
                    }

                    this.editingActionId = action.id;

                    // Show single-select, hide multi-select (edit mode)
                    document.getElementById('quick-action-school-single-group').style.display = 'block';
                    document.getElementById('quick-action-school-multi-group').style.display = 'none';
                    document.getElementById('quick-action-mode-group').style.display = 'none';
                    document.getElementById('quick-action-replace-group').style.display = 'none';
                    document.getElementById('quick-action-status-group').style.display = 'block';
                    document.getElementById('quick-action-delete-btn').style.display = 'block';

                    // Populate the single school dropdown
                    const schoolSelect = document.getElementById('quick-action-school');
                    schoolSelect.innerHTML = '<option value="">Select school...</option>';

                    const schools = App.Storage.getSchools();
                    schools.sort((a, b) => a.schoolName.localeCompare(b.schoolName));
                    schools.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = s.schoolName;
                        if (s.id === schoolId) option.selected = true;
                        schoolSelect.appendChild(option);
                    });

                    document.getElementById('quick-action-task').value = action.action || '';
                    document.getElementById('quick-action-owner').value = action.owner || '';
                    document.getElementById('quick-action-due').value = action.dueDate || '';
                    document.getElementById('quick-action-status').value = action.status || 'Pending';

                    // Change modal title to Edit
                    document.querySelector('#quick-action-modal .modal-title').textContent = 'Edit Action';

                    this.openModal('quick-action-modal');
                },

                // Show quick add action modal (multi-school mode)
                showQuickAddAction() {
                    const schools = App.Storage.getSchools();
                    this.editingActionId = null;

                    // Show multi-select, hide single select
                    document.getElementById('quick-action-school-single-group').style.display = 'none';
                    document.getElementById('quick-action-school-multi-group').style.display = 'block';
                    document.getElementById('quick-action-mode-group').style.display = 'none';
                    document.getElementById('quick-action-replace-group').style.display = 'none';
                    document.getElementById('quick-action-status-group').style.display = 'none'; // Hide status for new actions
                    document.getElementById('quick-action-delete-btn').style.display = 'none';

                    // Populate checkboxes with change listener for Add/Replace mode
                    const checkboxContainer = document.getElementById('quick-action-schools-checkboxes');
                    checkboxContainer.innerHTML = '';

                    schools.sort((a, b) => a.schoolName.localeCompare(b.schoolName));
                    schools.forEach(school => {
                        this.migrateSchoolActions(school);
                        const actionCount = school.actions ? school.actions.length : 0;
                        const actionLabel = actionCount > 0 ? ` (${actionCount} action${actionCount > 1 ? 's' : ''})` : '';
                        const div = document.createElement('div');
                        div.style.cssText = 'padding: 0.5rem; border-bottom: 1px solid var(--color-border);';
                        div.innerHTML = `
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" value="${school.id}" class="quick-action-school-checkbox" onchange="App.UI.onMultiSchoolCheckboxChange()">
                                <span>${school.schoolName}${actionLabel ? '<span class="text-muted" style="font-size: 0.75rem;">' + actionLabel + '</span>' : ''}</span>
                            </label>
                        `;
                        checkboxContainer.appendChild(div);
                    });

                    // Clear form and reset title
                    document.getElementById('quick-action-task').value = '';
                    document.getElementById('quick-action-owner').value = '';
                    document.getElementById('quick-action-due').value = '';
                    document.getElementById('quick-action-status').value = 'Pending';
                    document.querySelector('#quick-action-modal .modal-title').textContent = 'Add Action to Schools';

                    this.openModal('quick-action-modal');
                },

                // Handle checkbox change in multi-school mode - show Add/Replace when single school with actions selected
                onMultiSchoolCheckboxChange() {
                    const checkedBoxes = document.querySelectorAll('.quick-action-school-checkbox:checked');

                    if (checkedBoxes.length === 1) {
                        // Single school selected - check if it has actions
                        const schoolId = checkedBoxes[0].value;
                        const school = App.Storage.getSchool(schoolId);
                        if (school) {
                            this.migrateSchoolActions(school);
                            if (school.actions && school.actions.length > 0) {
                                // Show Add/Replace options
                                document.getElementById('quick-action-mode-group').style.display = 'block';
                                document.querySelector('input[name="quick-action-mode"][value="add"]').checked = true;
                                document.getElementById('quick-action-replace-group').style.display = 'none';
                                this.populateReplaceList(school);
                                return;
                            }
                        }
                    }

                    // Multiple schools or no actions - hide Add/Replace options
                    document.getElementById('quick-action-mode-group').style.display = 'none';
                    document.getElementById('quick-action-replace-group').style.display = 'none';
                },

                // Handle school select change (for single-school add mode)
                onSchoolSelectChange() {
                    if (this.editingActionId) return; // Don't show mode options when editing

                    const schoolId = document.getElementById('quick-action-school').value;
                    if (!schoolId) {
                        document.getElementById('quick-action-mode-group').style.display = 'none';
                        document.getElementById('quick-action-replace-group').style.display = 'none';
                        return;
                    }

                    const school = App.Storage.getSchool(schoolId);
                    if (!school) return;

                    this.migrateSchoolActions(school);

                    // Show mode options if school has existing actions
                    if (school.actions && school.actions.length > 0) {
                        document.getElementById('quick-action-mode-group').style.display = 'block';
                        // Reset to "add" mode
                        document.querySelector('input[name="quick-action-mode"][value="add"]').checked = true;
                        document.getElementById('quick-action-replace-group').style.display = 'none';
                        this.populateReplaceList(school);
                    } else {
                        document.getElementById('quick-action-mode-group').style.display = 'none';
                        document.getElementById('quick-action-replace-group').style.display = 'none';
                    }
                },

                // Handle action mode change (add new vs replace)
                onActionModeChange() {
                    const mode = document.querySelector('input[name="quick-action-mode"]:checked').value;
                    if (mode === 'replace') {
                        document.getElementById('quick-action-replace-group').style.display = 'block';
                    } else {
                        document.getElementById('quick-action-replace-group').style.display = 'none';
                    }
                },

                // Populate the replace action list
                populateReplaceList(school) {
                    const container = document.getElementById('quick-action-replace-list');
                    container.innerHTML = '';

                    if (!school.actions || school.actions.length === 0) return;

                    school.actions.forEach((action, index) => {
                        const div = document.createElement('div');
                        div.style.cssText = 'padding: 0.5rem; border-bottom: 1px solid var(--color-border);';
                        div.innerHTML = `
                            <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="quick-action-replace-id" value="${action.id}" ${index === 0 ? 'checked' : ''}>
                                <div>
                                    <div>${action.action}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">
                                        ${action.owner ? 'Owner: ' + action.owner + ' ¬∑ ' : ''}
                                        ${action.dueDate ? 'Due: ' + App.Utils.formatDate(action.dueDate) : 'No due date'}
                                    </div>
                                </div>
                            </label>
                        `;
                        container.appendChild(div);
                    });
                },

                // Migrate school from old single-action format to new multi-action format
                migrateSchoolActions(school) {
                    if (!school.actions) {
                        school.actions = [];
                        school.actionHistory = [];

                        // Migrate old single action if exists
                        if (school.nextAction) {
                            const migratedAction = {
                                id: App.Utils.generateId(),
                                action: school.nextAction,
                                owner: school.actionOwner || '',
                                dueDate: school.actionDueDate || '',
                                status: school.actionStatus || 'Pending',
                                createdAt: school.actionCreatedAt || new Date().toISOString(),
                                modifiedAt: school.actionModifiedAt || new Date().toISOString(),
                                completedAt: school.actionCompletedAt || null
                            };
                            school.actions.push(migratedAction);

                            // Add migration to history
                            school.actionHistory.push({
                                type: 'migrated',
                                actionId: migratedAction.id,
                                action: migratedAction.action,
                                timestamp: new Date().toISOString(),
                                by: 'System'
                            });
                        }
                    }
                },

                // Add action history entry
                addActionHistory(school, type, action, oldAction = null) {
                    if (!school.actionHistory) school.actionHistory = [];
                    const entry = {
                        type: type, // 'added', 'completed', 'modified', 'replaced', 'deleted'
                        actionId: action.id,
                        action: action.action,
                        timestamp: new Date().toISOString(),
                        by: action.owner || 'Unknown'
                    };
                    if (oldAction) {
                        entry.oldAction = oldAction.action;
                    }
                    school.actionHistory.push(entry);
                },

                // Save quick action (handles both single edit and multi-add modes)
                saveQuickAction() {
                    const task = document.getElementById('quick-action-task').value;
                    if (!task) {
                        alert('Please enter an action item.');
                        return;
                    }

                    const isMultiMode = document.getElementById('quick-action-school-multi-group').style.display !== 'none';
                    const owner = document.getElementById('quick-action-owner').value;
                    const dueDate = document.getElementById('quick-action-due').value;
                    const now = new Date().toISOString();

                    if (isMultiMode) {
                        // Multi-school mode (checkboxes)
                        const checkboxes = document.querySelectorAll('.quick-action-school-checkbox:checked');
                        if (checkboxes.length === 0) {
                            alert('Please select at least one school.');
                            return;
                        }

                        // Check if single school with replace mode
                        const mode = document.querySelector('input[name="quick-action-mode"]:checked')?.value || 'add';
                        const isSingleSchoolReplace = checkboxes.length === 1 && mode === 'replace';

                        if (isSingleSchoolReplace) {
                            // Single school replace mode
                            const replaceId = document.querySelector('input[name="quick-action-replace-id"]:checked')?.value;
                            if (!replaceId) {
                                alert('Please select an action to replace.');
                                return;
                            }

                            const school = App.Storage.getSchool(checkboxes[0].value);
                            if (school) {
                                this.migrateSchoolActions(school);
                                const oldActionIndex = school.actions.findIndex(a => a.id === replaceId);
                                if (oldActionIndex !== -1) {
                                    const oldAction = school.actions[oldActionIndex];
                                    const newAction = {
                                        id: App.Utils.generateId(),
                                        action: task,
                                        owner: owner,
                                        dueDate: dueDate,
                                        status: 'Pending',
                                        createdAt: now,
                                        modifiedAt: now,
                                        completedAt: null
                                    };
                                    // Remove old action and add new one
                                    school.actions.splice(oldActionIndex, 1, newAction);
                                    this.addActionHistory(school, 'replaced', newAction, oldAction);
                                    App.Storage.saveSchool(school);
                                }
                            }
                        } else {
                            // Multiple schools or add mode - add new actions
                            checkboxes.forEach(cb => {
                                const school = App.Storage.getSchool(cb.value);
                                if (school) {
                                    this.migrateSchoolActions(school);
                                    const newAction = {
                                        id: App.Utils.generateId(),
                                        action: task,
                                        owner: owner,
                                        dueDate: dueDate,
                                        status: 'Pending',
                                        createdAt: now,
                                        modifiedAt: now,
                                        completedAt: null
                                    };
                                    school.actions.push(newAction);
                                    this.addActionHistory(school, 'added', newAction);
                                    App.Storage.saveSchool(school);
                                }
                            });
                        }

                        this.closeModal('quick-action-modal');
                        this.renderActions();
                    } else if (this.editingActionId) {
                        // Single school edit mode (editing existing action)
                        const schoolId = document.getElementById('quick-action-school').value;
                        if (!schoolId) {
                            alert('Please select a school.');
                            return;
                        }

                        const school = App.Storage.getSchool(schoolId);
                        if (!school) return;

                        this.migrateSchoolActions(school);
                        const action = school.actions.find(a => a.id === this.editingActionId);
                        if (!action) return;

                        const newStatus = document.getElementById('quick-action-status').value;
                        const wasComplete = action.status === 'Complete';
                        const isNowComplete = newStatus === 'Complete';

                        // Update action
                        action.action = task;
                        action.owner = owner;
                        action.dueDate = dueDate;
                        action.status = newStatus;
                        action.modifiedAt = now;

                        // Handle completion timestamp
                        if (isNowComplete && !wasComplete) {
                            action.completedAt = now;
                            this.addActionHistory(school, 'completed', action);
                        } else if (!isNowComplete && wasComplete) {
                            action.completedAt = null;
                            this.addActionHistory(school, 'modified', action);
                        } else {
                            this.addActionHistory(school, 'modified', action);
                        }

                        App.Storage.saveSchool(school);
                        this.closeModal('quick-action-modal');
                        this.renderActions();
                        this.editingActionId = null;
                    } else {
                        // Single school add mode (with optional replace)
                        const schoolId = document.getElementById('quick-action-school').value;
                        if (!schoolId) {
                            alert('Please select a school.');
                            return;
                        }

                        const school = App.Storage.getSchool(schoolId);
                        if (!school) return;

                        this.migrateSchoolActions(school);

                        const mode = document.querySelector('input[name="quick-action-mode"]:checked')?.value || 'add';

                        if (mode === 'replace' && school.actions.length > 0) {
                            // Replace existing action
                            const replaceId = document.querySelector('input[name="quick-action-replace-id"]:checked')?.value;
                            if (!replaceId) {
                                alert('Please select an action to replace.');
                                return;
                            }

                            const oldActionIndex = school.actions.findIndex(a => a.id === replaceId);
                            if (oldActionIndex === -1) return;

                            const oldAction = school.actions[oldActionIndex];
                            const newAction = {
                                id: App.Utils.generateId(),
                                action: task,
                                owner: owner,
                                dueDate: dueDate,
                                status: 'Pending',
                                createdAt: now,
                                modifiedAt: now,
                                completedAt: null
                            };

                            // Replace the action
                            school.actions.splice(oldActionIndex, 1, newAction);
                            this.addActionHistory(school, 'replaced', newAction, oldAction);
                        } else {
                            // Add new action
                            const newAction = {
                                id: App.Utils.generateId(),
                                action: task,
                                owner: owner,
                                dueDate: dueDate,
                                status: 'Pending',
                                createdAt: now,
                                modifiedAt: now,
                                completedAt: null
                            };
                            school.actions.push(newAction);
                            this.addActionHistory(school, 'added', newAction);
                        }

                        App.Storage.saveSchool(school);
                        this.closeModal('quick-action-modal');
                        this.renderActions();
                    }
                },

                // Delete action from school
                deleteQuickAction() {
                    const schoolId = document.getElementById('quick-action-school').value;
                    if (!schoolId || !this.editingActionId) return;

                    if (!confirm('Delete this action item?')) return;

                    const school = App.Storage.getSchool(schoolId);
                    if (!school) return;

                    this.migrateSchoolActions(school);

                    const actionIndex = school.actions.findIndex(a => a.id === this.editingActionId);
                    if (actionIndex === -1) return;

                    const deletedAction = school.actions[actionIndex];
                    school.actions.splice(actionIndex, 1);
                    this.addActionHistory(school, 'deleted', deletedAction);

                    App.Storage.saveSchool(school);
                    this.closeModal('quick-action-modal');
                    this.renderActions();
                    this.editingActionId = null;
                },

                // Show add action for a specific school (single school mode)
                showAddActionForSchool(schoolId) {
                    const school = App.Storage.getSchool(schoolId);
                    if (!school) return;

                    this.editingActionId = null;
                    this.migrateSchoolActions(school);

                    // Show single-select, hide multi-select
                    document.getElementById('quick-action-school-single-group').style.display = 'block';
                    document.getElementById('quick-action-school-multi-group').style.display = 'none';
                    document.getElementById('quick-action-status-group').style.display = 'none';
                    document.getElementById('quick-action-delete-btn').style.display = 'none';

                    // Populate the single school dropdown
                    const schoolSelect = document.getElementById('quick-action-school');
                    schoolSelect.innerHTML = '<option value="">Select school...</option>';

                    const schools = App.Storage.getSchools();
                    schools.sort((a, b) => a.schoolName.localeCompare(b.schoolName));
                    schools.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = s.schoolName;
                        if (s.id === schoolId) option.selected = true;
                        schoolSelect.appendChild(option);
                    });

                    // Clear form
                    document.getElementById('quick-action-task').value = '';
                    document.getElementById('quick-action-owner').value = '';
                    document.getElementById('quick-action-due').value = '';
                    document.getElementById('quick-action-status').value = 'Pending';

                    // Show mode options if school has existing actions
                    if (school.actions && school.actions.length > 0) {
                        document.getElementById('quick-action-mode-group').style.display = 'block';
                        document.querySelector('input[name="quick-action-mode"][value="add"]').checked = true;
                        document.getElementById('quick-action-replace-group').style.display = 'none';
                        this.populateReplaceList(school);
                    } else {
                        document.getElementById('quick-action-mode-group').style.display = 'none';
                        document.getElementById('quick-action-replace-group').style.display = 'none';
                    }

                    document.querySelector('#quick-action-modal .modal-title').textContent = 'Add Action to ' + school.schoolName;
                    this.openModal('quick-action-modal');
                },

                // Show add school modal
                showAddSchoolModal() {
                    document.getElementById('modal-title').textContent = 'Add School';
                    document.getElementById('school-form').reset();
                    document.getElementById('form-school-id').value = '';
                    this.editingSchoolId = null;
                    this.openModal('school-modal');
                },

                // Edit school
                editSchool(schoolId) {
                    const school = App.Storage.getSchool(schoolId);
                    if (!school) return;

                    document.getElementById('modal-title').textContent = 'Edit School';
                    document.getElementById('form-school-id').value = school.id;
                    document.getElementById('form-school-name').value = school.schoolName || '';
                    document.getElementById('form-level').value = school.level || '';
                    document.getElementById('form-location').value = school.location || '';
                    document.getElementById('form-conference').value = school.conference || '';
                    document.getElementById('form-head-coach').value = school.headCoach || '';
                    document.getElementById('form-te-coach').value = school.positionCoach || '';
                    document.getElementById('form-recruiting-contact').value = school.recruitingContact || '';
                    document.getElementById('form-phone').value = school.phone || '';
                    document.getElementById('form-email').value = school.email || '';
                    document.getElementById('form-twitter').value = school.twitter || '';
                    document.getElementById('form-interest-our').value = school.ourInterestLevel || 'High';
                    document.getElementById('form-interest-their').value = school.theirInterestLevel || 'Unknown';
                    document.getElementById('form-likelihood').value = school.likelihood || 'Target';
                    document.getElementById('form-offer-status').value = school.offerStatus || 'None';
                    document.getElementById('form-next-action').value = school.nextAction || '';
                    document.getElementById('form-action-owner').value = school.actionOwner || '';
                    document.getElementById('form-action-due').value = school.actionDueDate || '';
                    document.getElementById('form-action-status').value = school.actionStatus || 'Pending';
                    document.getElementById('form-notes').value = school.notes || '';

                    this.editingSchoolId = schoolId;
                    this.openModal('school-modal');
                },

                // Save school
                saveSchool() {
                    const form = document.getElementById('school-form');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    const schoolData = {
                        id: document.getElementById('form-school-id').value || undefined,
                        schoolName: document.getElementById('form-school-name').value,
                        level: document.getElementById('form-level').value,
                        location: document.getElementById('form-location').value,
                        conference: document.getElementById('form-conference').value,
                        headCoach: document.getElementById('form-head-coach').value,
                        positionCoach: document.getElementById('form-te-coach').value,
                        recruitingContact: document.getElementById('form-recruiting-contact').value,
                        phone: document.getElementById('form-phone').value,
                        email: document.getElementById('form-email').value,
                        twitter: document.getElementById('form-twitter').value,
                        ourInterestLevel: document.getElementById('form-interest-our').value,
                        theirInterestLevel: document.getElementById('form-interest-their').value,
                        likelihood: document.getElementById('form-likelihood').value,
                        offerStatus: document.getElementById('form-offer-status').value,
                        notes: document.getElementById('form-notes').value,

                        // Action item fields with timestamps
                        nextAction: document.getElementById('form-next-action').value,
                        actionOwner: document.getElementById('form-action-owner').value,
                        actionDueDate: document.getElementById('form-action-due').value,
                        actionStatus: document.getElementById('form-action-status').value,
                        // Set timestamps based on action changes
                        actionCreatedAt: this.editingSchoolId ?
                            (App.Storage.getSchool(this.editingSchoolId).actionCreatedAt ||
                             (document.getElementById('form-next-action').value ? new Date().toISOString() : null)) :
                            (document.getElementById('form-next-action').value ? new Date().toISOString() : null),
                        actionModifiedAt: document.getElementById('form-next-action').value ? new Date().toISOString() : null,
                        actionCompletedAt: document.getElementById('form-action-status').value === 'Complete' ?
                            (this.editingSchoolId && App.Storage.getSchool(this.editingSchoolId).actionCompletedAt ?
                             App.Storage.getSchool(this.editingSchoolId).actionCompletedAt : new Date().toISOString()) : null,

                        // Preserve existing data
                        contactHistory: this.editingSchoolId ?
                            App.Storage.getSchool(this.editingSchoolId).contactHistory : [],
                        actionHistory: this.editingSchoolId ?
                            App.Storage.getSchool(this.editingSchoolId).actionHistory : [],
                        ratings: this.editingSchoolId ?
                            App.Storage.getSchool(this.editingSchoolId).ratings : {
                                coach: 0, programFit: 0, financial: 0, academic: 0, location: 0, overall: 0
                            },
                        aiAnalysis: this.editingSchoolId ?
                            App.Storage.getSchool(this.editingSchoolId).aiAnalysis : null
                    };

                    App.Storage.saveSchool(schoolData);
                    this.closeModal('school-modal');
                    this.renderDashboard();
                },

                // Delete school
                deleteSchool(schoolId) {
                    const school = App.Storage.getSchool(schoolId);
                    if (!school) return;

                    document.getElementById('delete-school-name').textContent = school.schoolName;
                    this.deletingSchoolId = schoolId;
                    this.openModal('delete-modal');
                },

                // Confirm delete
                confirmDelete() {
                    if (this.deletingSchoolId) {
                        App.Storage.deleteSchool(this.deletingSchoolId);
                        this.deletingSchoolId = null;
                        this.closeModal('delete-modal');
                        this.showView('dashboard');
                    }
                },

                // Modal helpers
                openModal(modalId) {
                    document.getElementById(modalId).classList.add('active');
                },

                closeModal(modalId) {
                    document.getElementById(modalId).classList.remove('active');
                },

                // Show team setup modal
                showTeamSetupModal() {
                    document.getElementById('team-setup-modal').classList.add('active');
                },

                // Create team from modal
                async createTeamFromModal() {
                    const teamName = document.getElementById('new-team-name').value.trim() || "Joseph's Recruiting Team";

                    try {
                        const team = await App.Team.createTeam(teamName);

                        // Show success message with team ID for sharing
                        alert(`Team created successfully!\n\nTeam Name: ${team.name}\nTeam ID: ${team.id}\n\nShare this Team ID with family members and coaches so they can join.`);

                        // Close modal
                        this.closeModal('team-setup-modal');

                        // Start migration and sync
                        await App.CloudSync.migrateLocalToCloud();
                        App.CloudSync.startRealtimeSync();

                        // Refresh dashboard
                        this.renderDashboard();
                    } catch (error) {
                        console.error('Error creating team:', error);
                        alert('Failed to create team: ' + error.message);
                    }
                },

                // Join team from modal
                async joinTeamFromModal() {
                    const teamId = document.getElementById('join-team-id').value.trim();

                    if (!teamId) {
                        alert('Please enter a Team ID');
                        return;
                    }

                    try {
                        const team = await App.Team.joinTeam(teamId);

                        // Show success message
                        alert(`Successfully joined team: ${team.name}`);

                        // Close modal
                        this.closeModal('team-setup-modal');

                        // Start real-time sync (no migration needed, we're joining existing data)
                        App.CloudSync.startRealtimeSync();

                        // Refresh dashboard
                        this.renderDashboard();
                    } catch (error) {
                        console.error('Error joining team:', error);
                        alert('Failed to join team: ' + error.message);
                    }
                }
            },

            // ===== UTILS MODULE =====
            Utils: {
                // Generate UUID v4
                generateUUID() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                },

                // Generate shorter ID for actions
                generateId() {
                    return 'action_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                },

                // Format date
                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            }
        };

        // Initialize app on load
        document.addEventListener('DOMContentLoaded', () => {
            App.Storage.init();
            App.Auth.init();
            App.UI.init();
        });
    </script>
</body>
</html>